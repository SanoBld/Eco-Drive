<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Calculateur d'√©co-conduite intelligent avec √©tapes et g√©olocalisation.">
    <meta name="theme-color" content="#fbfdf8">
    <title>Eco-Drive - Planificateur Intelligent</title>
    
    <!-- Leaflet & Fonts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <style>
        :root {
            /* Material You Tokens */
            --md-primary: #006d3b;
            --md-on-primary: #ffffff;
            --md-primary-container: #99f6b4;
            --md-on-primary-container: #00210e;
            --md-secondary-container: #dce5dd;
            --md-on-secondary-container: #151d19;
            --md-surface: #fbfdf8;
            --md-surface-translucent: rgba(251, 253, 248, 0.85);
            --md-on-surface: #191c1a;
            --md-outline: #717972;
            --md-surface-variant: #dfe4dd;
            --shadow-elevation: 0 8px 32px rgba(0,0,0,0.1);
            --fab-bg: #e3fae9;
            --border-radius: 28px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --md-primary: #7cda9a;
                --md-on-primary: #00391c;
                --md-primary-container: #00522b;
                --md-on-primary-container: #99f6b4;
                --md-secondary-container: #3e4a42;
                --md-on-secondary-container: #dce5dd;
                --md-surface: #111412;
                --md-surface-translucent: rgba(17, 20, 18, 0.85);
                --md-on-surface: #e1e3df;
                --md-outline: #8b938b;
                --md-surface-variant: #424940;
                --fab-bg: #2a332d;
            }
        }

        body.dark-theme {
            --md-primary: #7cda9a;
            --md-on-primary: #00391c;
            --md-primary-container: #00522b;
            --md-on-primary-container: #99f6b4;
            --md-secondary-container: #3e4a42;
            --md-on-secondary-container: #dce5dd;
            --md-surface: #111412;
            --md-surface-translucent: rgba(17, 20, 18, 0.85);
            --md-on-surface: #e1e3df;
            --md-outline: #8b938b;
            --md-surface-variant: #424940;
            --fab-bg: #2a332d;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0; height: 100vh;
            display: flex; flex-direction: column;
            background: var(--md-surface);
            color: var(--md-on-surface);
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Map Section --- */
        #map-container { flex: 1; width: 100%; position: relative; z-index: 1; }
        #map { width: 100%; height: 100%; background: var(--md-surface-variant); }
        .leaflet-routing-container { display: none !important; }

        /* Styles am√©lior√©s pour la carte */
        .leaflet-bar a { background-color: var(--md-surface) !important; color: var(--md-on-surface) !important; border-color: var(--md-outline) !important; }

        /* Marker Pulse */
        .pulse-icon {
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(0, 109, 59, 1);
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 109, 59, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 109, 59, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 109, 59, 0); }
        }

        /* --- Controls --- */
        .map-controls {
            position: absolute; top: 16px; right: 16px; z-index: 1000;
            display: flex; flex-direction: column; gap: 12px;
        }
        .fab {
            width: 48px; height: 48px; border-radius: 16px;
            background: var(--fab-bg); color: var(--md-on-surface);
            box-shadow: var(--shadow-elevation); border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s, background-color 0.3s;
            backdrop-filter: blur(4px);
        }
        .fab:hover { filter: brightness(0.95); transform: translateY(-2px); }
        .fab:active { transform: scale(0.92); }
        
        /* --- Bottom Sheet --- */
        #sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--md-surface-translucent);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.15);
            z-index: 2000;
            padding: 0 20px 24px 20px;
            max-height: 85vh; overflow-y: auto;
            transform: translateY(calc(100% - 150px));
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        #sheet.expanded { transform: translateY(0); }

        .drag-area {
            width: 100%; height: 32px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: sticky; top: 0; z-index: 10;
        }
        .drag-handle {
            width: 40px; height: 5px; background: var(--md-outline);
            border-radius: 10px; opacity: 0.3;
        }

        /* Cards & Inputs */
        .section-title {
            font-size: 0.85rem; font-weight: 700; color: var(--md-primary);
            margin: 16px 0 8px 4px; text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .card {
            background: var(--md-secondary-container);
            border-radius: 20px; padding: 16px;
            display: flex; flex-direction: column; gap: 12px; margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        /* Waypoints container */
        .waypoints-list {
            display: flex; flex-direction: column; gap: 10px;
        }
        
        .input-group {
            position: relative;
            display: flex; align-items: center;
        }
        
        .input-field label {
            font-size: 0.8rem; font-weight: 500; color: var(--md-on-surface);
            margin-bottom: 6px; display: block; opacity: 0.8;
        }
        
        input, select {
            background: var(--md-surface); border: 2px solid transparent;
            border-radius: 12px; padding: 12px; font-size: 1rem;
            color: var(--md-on-surface); width: 100%; outline: none;
            font-family: 'Roboto', sans-serif; transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        input:focus, select:focus {
            border-color: var(--md-primary); background: var(--md-surface);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        /* Input icons */
        .input-icon-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: none; border: none; cursor: pointer;
            color: var(--md-primary); padding: 8px;
            display: flex; align-items: center; justify-content: center;
        }
        .input-icon-btn:hover { background: rgba(0,0,0,0.05); border-radius: 50%; }

        .remove-wp-btn {
            color: var(--md-outline); margin-left: 8px;
            background: none; border: none; cursor: pointer;
        }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* Results */
        #result-box {
            background: linear-gradient(135deg, var(--md-primary-container), var(--md-primary));
            color: var(--md-on-primary-container);
            padding: 24px; border-radius: 24px;
            text-align: center; margin: 24px 0;
            position: relative; overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 109, 59, 0.15);
        }
        #result-box * { color: #ffffff !important; } /* Force text white on gradient */
        
        .result-content { position: relative; z-index: 1; }
        .price-main { font-size: 3rem; font-weight: 700; font-family: 'Google Sans'; line-height: 1; margin-bottom: 4px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .price-sub { opacity: 0.9; font-size: 0.95rem; font-weight: 500; }

        /* Buttons */
        .btn-primary {
            background: var(--md-primary); color: var(--md-on-primary);
            border: none; padding: 18px; border-radius: 30px;
            font-weight: 600; font-size: 1.1rem; font-family: 'Google Sans';
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; box-shadow: var(--shadow-elevation);
            transition: all 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); }

        .toolbar { display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .toolbar::-webkit-scrollbar { display: none; }
        
        .chip-btn {
            background: var(--md-surface-variant); color: var(--md-on-surface);
            border: none; padding: 8px 16px; border-radius: 20px;
            font-size: 0.85rem; font-weight: 500; white-space: nowrap;
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            transition: background 0.2s;
        }
        .chip-btn:active { background: var(--md-outline); color: var(--md-surface); }

        .add-stop-btn {
            background: none; border: none; color: var(--md-primary);
            font-size: 0.8rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 4px;
            padding: 4px 8px; border-radius: 8px;
        }
        .add-stop-btn:hover { background: rgba(0,0,0,0.05); }

        /* Footer */
        .app-footer {
            text-align: center; font-size: 0.75rem; color: var(--md-on-surface);
            opacity: 0.6; padding: 20px 0 10px 0; margin-top: auto;
        }
        .ai-badge {
            display: inline-flex; align-items: center; gap: 4px;
            background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 8px;
            margin-top: 8px;
        }

        /* Desktop */
        @media (min-width: 768px) {
            #sheet {
                width: 440px; left: 24px; bottom: 24px; top: 24px;
                border-radius: 32px; transform: none !important;
                max-height: calc(100vh - 48px);
            }
            .drag-area { display: none; }
        }
        
        #fileInput { display: none; }
    </style>
</head>
<body>

<div id="map-container" aria-label="Carte interactive">
    <div id="map" role="application" aria-label="Carte affichant le trajet"></div>
    <div class="map-controls">
        <button class="fab" onclick="toggleThemeManual()" aria-label="Changer le th√®me">
            <span class="material-symbols-rounded">contrast</span>
        </button>
        <button class="fab" onclick="fitRoute()" aria-label="Recentrer la carte">
            <span class="material-symbols-rounded">my_location</span>
        </button>
    </div>
</div>

<div id="sheet" id="mainSheet" role="region" aria-label="Panneau de configuration du trajet">
    <div class="drag-area" onclick="toggleSheet()" aria-hidden="true">
        <div class="drag-handle"></div>
    </div>

    <div class="toolbar">
        <button class="chip-btn" onclick="saveTrip()">
            <span class="material-symbols-rounded" style="font-size:18px">save</span> Sauvegarder
        </button>
        <button class="chip-btn" onclick="document.getElementById('fileInput').click()">
            <span class="material-symbols-rounded" style="font-size:18px">upload</span> Importer
        </button>
        <input type="file" id="fileInput" accept=".json" onchange="loadTrip(this)" aria-hidden="true">
    </div>
    
    <div class="section-title">
        <span>Itin√©raire</span>
        <button class="add-stop-btn" onclick="addWaypoint()">
            <span class="material-symbols-rounded" style="font-size:18px">add_circle</span> Ajouter √©tape
        </button>
    </div>
    
    <div class="card" id="itinerary-card">
        <div class="waypoints-list" id="waypoints-container">
            <!-- Start Input -->
            <div class="input-group" id="wp-group-0">
                <input type="text" class="addr-input" id="startAddr" placeholder="D√©part" onchange="planTrip()" aria-label="Adresse de d√©part">
                <button class="input-icon-btn" onclick="locateMe('startAddr')" title="Ma position">
                    <span class="material-symbols-rounded">near_me</span>
                </button>
            </div>
            <!-- Destination Input (Moved by JS if steps added) -->
            <div class="input-group" id="wp-group-end">
                <input type="text" class="addr-input" id="endAddr" placeholder="Destination" onchange="planTrip()" aria-label="Adresse d'arriv√©e">
            </div>
        </div>
    </div>

    <div class="section-title">V√©hicule & Carburant</div>
    <div class="card">
        <div class="input-field">
            <label for="vehicleType">Type de v√©hicule</label>
            <select id="vehicleType" onchange="updateFuelOptions()">
                <option value="sedan">Berline / Compacte</option>
                <option value="suv">SUV / 4x4</option>
                <option value="city">Citadine</option>
                <option value="moto">Moto</option>
                <option value="van">Utilitaire</option>
                <option value="custom">Personnalis√©</option>
            </select>
        </div>
        <div class="row">
            <div class="input-field">
                <label for="fuelType">√ânergie</label>
                <select id="fuelType" onchange="applyPreset()">
                    <option value="essence">Essence (SP95/98)</option>
                    <option value="diesel">Diesel (B7)</option>
                    <option value="elec">√âlectrique</option>
                    <option value="ethanol">√âthanol (E85)</option>
                    <option value="gpl">GPL</option>
                </select>
            </div>
            <div class="input-field">
                <label for="drivingStyle">Conduite</label>
                <select id="drivingStyle" onchange="calculate()">
                    <option value="1.0">Normale</option>
                    <option value="0.9">√âco (-10%)</option>
                    <option value="1.15">Sportive (+15%)</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="input-field">
                <label id="consoLabel" for="conso">Conso. (L/100km)</label>
                <input type="number" id="conso" value="6.5" step="0.1" oninput="calculate()">
            </div>
            <div class="input-field" style="position:relative">
                <label id="priceLabel" for="price">Prix (‚Ç¨/L)</label>
                <input type="number" id="price" value="1.75" step="0.01" oninput="calculate()">
                <button onclick="fetchFuelPrice()" title="Mettre √† jour" style="position:absolute; right:8px; top:34px; background:none; border:none; cursor:pointer; color:var(--md-primary);">
                    <span class="material-symbols-rounded">autorenew</span>
                </button>
            </div>
        </div>
    </div>
    
    <input type="hidden" id="distance" value="0">

    <div id="result-box">
        <div class="result-content">
            <span id="total-val" class="price-main">0.00 ‚Ç¨</span>
            <span id="pp-val" class="price-sub">Co√ªt estim√© du trajet</span>
        </div>
    </div>

    <button class="btn-primary" onclick="shareTrip()">
        <span class="material-symbols-rounded">ios_share</span>
        Partager le r√©sum√©
    </button>

    <footer class="app-footer">
        <div>Eco-Drive v2.1 &bull; Donn√©es OpenStreetMap</div>
        <div class="ai-badge">
            <span class="material-symbols-rounded" style="font-size:14px">auto_awesome</span>
            Con√ßu avec l'assistance d'une IA
        </div>
    </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>

<script>
    // --- 1. Map Initialization & Theming ---
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([46.603354, 1.888334], 6);
    L.control.attribution({ position: 'bottomright' }).addTo(map);

    let tileLayer;
    const lightTiles = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
    const darkTiles = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';

    function initMapTheme() {
        const isDark = document.body.classList.contains('dark-theme') || 
                       (!document.body.classList.contains('light-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
        
        const url = isDark ? darkTiles : lightTiles;
        if (tileLayer) map.removeLayer(tileLayer);
        tileLayer = L.tileLayer(url, {
            attribution: '&copy; OpenStreetMap, &copy; CartoDB',
            maxZoom: 19
        }).addTo(map);
    }

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', initMapTheme);

    function toggleThemeManual() {
        const body = document.body;
        if (body.classList.contains('dark-theme')) {
            body.classList.remove('dark-theme');
            body.classList.add('light-theme');
        } else if (body.classList.contains('light-theme')) {
            body.classList.remove('light-theme');
            body.classList.add('dark-theme');
        } else {
            const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            body.classList.add(sysDark ? 'light-theme' : 'dark-theme');
        }
        initMapTheme();
    }
    initMapTheme();

    // --- 2. Waypoints Logic ---
    let waypointCount = 0;
    
    function addWaypoint() {
        waypointCount++;
        const container = document.getElementById('waypoints-container');
        const endGroup = document.getElementById('wp-group-end');
        
        const div = document.createElement('div');
        div.className = 'input-group';
        div.id = `wp-group-${waypointCount}`;
        div.innerHTML = `
            <input type="text" class="addr-input" placeholder="√âtape ${waypointCount}" onchange="planTrip()">
            <button class="remove-wp-btn" onclick="removeWaypoint(${waypointCount})">
                <span class="material-symbols-rounded">close</span>
            </button>
        `;
        
        // Insert before Destination
        container.insertBefore(div, endGroup);
    }

    function removeWaypoint(id) {
        const el = document.getElementById(`wp-group-${id}`);
        if(el) el.remove();
        planTrip();
    }

    // --- 3. Geolocation ---
    let userLocation = null;

    function locateMe(inputId) {
        const btn = document.querySelector(`#${inputId} + button span`);
        const originalIcon = btn.innerText;
        btn.innerText = 'hourglass_top'; // Loading icon

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                userLocation = L.latLng(position.coords.latitude, position.coords.longitude);
                document.getElementById(inputId).value = "Ma position actuelle";
                btn.innerText = 'my_location';
                planTrip();
            }, () => {
                alert("Impossible de vous g√©olocaliser.");
                btn.innerText = originalIcon;
            });
        } else {
            alert("G√©olocalisation non support√©e.");
        }
    }

    // --- 4. Routing Logic ---
    let routeControl = null;
    let carMarker = null;
    let animationFrameId = null;

    function toggleSheet() {
        if (window.innerWidth < 768) document.getElementById('sheet').classList.toggle('expanded');
    }
    // Auto-expand on focus
    document.addEventListener('focusin', (e) => {
        if (window.innerWidth < 768 && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT')) {
            document.getElementById('sheet').classList.add('expanded');
        }
    });

    function planTrip() {
        // Collect all addresses
        const inputs = document.querySelectorAll('.waypoints-list input');
        const addresses = Array.from(inputs).map(i => i.value.trim()).filter(v => v !== "");
        
        if (addresses.length < 2) return; // Need at least start + end

        if (routeControl) { map.removeControl(routeControl); routeControl = null; }
        if (carMarker) { map.removeLayer(carMarker); cancelAnimationFrame(animationFrameId); }

        // Geocode everything
        const promises = addresses.map(addr => {
            if (addr === "Ma position actuelle" && userLocation) {
                return Promise.resolve({ lat: userLocation.lat, lon: userLocation.lng });
            }
            return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`)
                .then(r => r.json())
                .then(data => data.length > 0 ? { lat: data[0].lat, lon: data[0].lon } : null);
        });

        Promise.all(promises).then(results => {
            if (results.some(r => r === null)) return alert("Une ou plusieurs adresses sont introuvables.");

            const waypoints = results.map(r => L.latLng(r.lat, r.lon));

            routeControl = L.Routing.control({
                waypoints: waypoints,
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                lineOptions: { styles: [{ color: 'var(--md-primary)', weight: 6, opacity: 0.8 }] },
                createMarker: function(i, wp, n) {
                    // Start (0), End (n-1), or Middle
                    let color = '#717972'; // Middle
                    if (i === 0) color = 'var(--md-primary)';
                    if (i === n - 1) color = '#B71C1C';

                    return L.marker(wp.latLng, {
                        draggable: true,
                        icon: L.divIcon({
                            className: 'pulse-icon',
                            html: `<div style="background-color:${color}; width:12px; height:12px; border-radius:50%; margin:4px; border:2px solid white;"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                },
                addWaypoints: false,
                show: false
            }).on('routesfound', function(e) {
                const route = e.routes[0];
                document.getElementById('distance').value = (route.summary.totalDistance / 1000).toFixed(1);
                
                calculate();
                fitRoute();
                animateCarSmooth(route.coordinates);
                
                if (window.innerWidth < 768) document.getElementById('sheet').classList.add('expanded');
            }).addTo(map);
        }).catch(() => alert("Erreur de connexion."));
    }

    function fitRoute() {
        if(routeControl) {
            const wps = routeControl.getWaypoints().filter(w => w.latLng);
            if(wps.length >= 2) {
                map.fitBounds(L.latLngBounds(wps.map(w => w.latLng)), { 
                    padding: [50, 50], 
                    paddingBottomRight: [0, window.innerWidth < 768 ? 350 : 0] 
                });
            }
        }
    }

    // --- 5. Advanced Animation (Pixel-based + Smooth Rotation) ---
    function animateCarSmooth(coords) {
        if (!coords || coords.length < 2) return;

        // Custom SVG Car Icon (Pointing UP by default in SVG)
        const carIcon = L.divIcon({
            html: `<div class="car-wrapper" style="width:40px; height:40px; transform-origin:center; filter:drop-shadow(0 4px 6px rgba(0,0,0,0.3)); will-change:transform;">
                    <svg viewBox="0 0 24 24" fill="var(--md-primary)" xmlns="http://www.w3.org/2000/svg" style="display:block;">
                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5H6.5c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 7h11l1.27 3.66L19.14 12H4.86l.37-1.34L6.5 7zM5 18c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm14 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
                    </svg>
                   </div>`,
            className: '',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        carMarker = L.marker(coords[0], { icon: carIcon, zIndexOffset: 999 }).addTo(map);

        let startTime = null;
        // Total duration depends on total distance logic or just fixed point speed
        // Better: Constant speed on screen (pixels/sec) or fixed time?
        // Let's stick to simple time-based but normalized
        const totalDuration = coords.length * 30; // 30ms per coordinate point
        
        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            let progress = elapsed / totalDuration;

            if (progress >= 1) {
                progress = 0;
                startTime = timestamp; 
            }

            const totalPoints = coords.length - 1;
            const currentPointIndex = Math.floor(progress * totalPoints);
            const nextPointIndex = Math.min(currentPointIndex + 1, totalPoints);
            const segmentProgress = (progress * totalPoints) - currentPointIndex;

            const currentLatLng = coords[currentPointIndex];
            const nextLatLng = coords[nextPointIndex];

            // Lerp Lat/Lng
            const lat = currentLatLng.lat + (nextLatLng.lat - currentLatLng.lat) * segmentProgress;
            const lng = currentLatLng.lng + (nextLatLng.lng - currentLatLng.lng) * segmentProgress;
            
            carMarker.setLatLng([lat, lng]);

            // Calculate Rotation based on Projected Points (Pixels) for accuracy
            // Using a tiny lookahead to smooth jitter
            const p1 = map.latLngToContainerPoint(currentLatLng);
            const p2 = map.latLngToContainerPoint(nextLatLng);
            
            // Only rotate if moved enough to have a direction
            const dist = p1.distanceTo(p2);
            if (dist > 1) {
                // atan2(y, x). Leaflet: Y is down.
                // Car SVG points UP (-Y).
                // Angle 0 (Right) -> Rotate 90.
                // Angle 90 (Down) -> Rotate 180.
                // Angle -90 (Up) -> Rotate 0.
                const angleRad = Math.atan2(p2.y - p1.y, p2.x - p1.x);
                const angleDeg = angleRad * (180 / Math.PI);
                const cssRotation = angleDeg + 90; // Adjust for "Up" facing SVG

                const el = carMarker.getElement().querySelector('.car-wrapper');
                if(el) el.style.transform = `rotate(${cssRotation}deg)`;
            }

            animationFrameId = requestAnimationFrame(animate);
        }
        animationFrameId = requestAnimationFrame(animate);
    }

    // --- 6. Calc Logic ---
    const presets = {
        sedan: { essence: 6.8, diesel: 5.5, elec: 16.0, ethanol: 8.5, gpl: 8.2 },
        suv: { essence: 8.5, diesel: 7.0, elec: 20.0, ethanol: 10.5, gpl: 10.0 },
        city: { essence: 5.2, diesel: 4.2, elec: 13.5, ethanol: 6.5, gpl: 6.5 },
        moto: { essence: 4.0, diesel: 3.5, elec: 8.0, ethanol: 5.0, gpl: 5.0 },
        van: { essence: 10.0, diesel: 8.0, elec: 24.0, ethanol: 12.0, gpl: 12.0 },
        custom: {} // No preset
    };

    function updateFuelOptions() {
        applyPreset();
    }

    function applyPreset() {
        const vType = document.getElementById('vehicleType').value;
        const fType = document.getElementById('fuelType').value;
        
        const isElec = fType === 'elec';
        document.getElementById('consoLabel').innerText = isElec ? "Conso. (kWh/100km)" : "Conso. (L/100km)";
        document.getElementById('priceLabel').innerText = isElec ? "Prix (‚Ç¨/kWh)" : "Prix (‚Ç¨/L)";

        // Set preset consumption only if not custom
        if (vType !== 'custom' && presets[vType] && presets[vType][fType]) {
            document.getElementById('conso').value = presets[vType][fType];
        } else if (vType === 'custom') {
            // Optional: Don't change value, let user edit
        }

        let price = 1.75;
        if(fType === 'diesel') price = 1.65;
        if(fType === 'ethanol') price = 0.85;
        if(fType === 'gpl') price = 0.99;
        if(fType === 'elec') price = 0.22; 
        
        // Don't override price if user manually edited it? 
        // For simplicity we reset it on type change, but maybe check if 'custom'
        document.getElementById('price').value = price;
        calculate();
    }

    function calculate() {
        const d = parseFloat(document.getElementById('distance').value) || 0;
        const c = parseFloat(document.getElementById('conso').value) || 0;
        const p = parseFloat(document.getElementById('price').value) || 0;
        const styleFactor = parseFloat(document.getElementById('drivingStyle').value) || 1;
        
        const total = (d * (c / 100) * styleFactor) * p;
        
        document.getElementById('total-val').innerText = total.toFixed(2) + " ‚Ç¨";
        document.getElementById('pp-val').innerText = `Co√ªt pour ${d} km (${document.getElementById('drivingStyle').selectedOptions[0].text})`;
    }

    function fetchFuelPrice() {
        const btn = document.querySelector('button[title="Mettre √† jour"] span');
        btn.style.animation = "spin 0.5s linear infinite";
        setTimeout(() => {
            btn.style.animation = "none";
            const current = parseFloat(document.getElementById('price').value);
            const variance = (Math.random() * 0.1) - 0.05;
            document.getElementById('price').value = (current + variance).toFixed(3);
            calculate();
        }, 600);
    }

    // --- 7. Save/Load ---
    function saveTrip() {
        // Start/End are dynamic now, but logic remains similar for simple save
        // We save the inputs values
        const inputs = document.querySelectorAll('.waypoints-list input');
        const addresses = Array.from(inputs).map(i => i.value);

        const data = {
            waypoints: addresses,
            vType: document.getElementById('vehicleType').value,
            fType: document.getElementById('fuelType').value,
            conso: document.getElementById('conso').value,
            price: document.getElementById('price').value
        };
        const blob = new Blob([JSON.stringify(data)], {type : 'application/json'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `eco-trip-${Date.now()}.json`;
        link.click();
    }

    function loadTrip(input) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                // Restore Waypoints
                if (data.waypoints && Array.isArray(data.waypoints)) {
                    // Reset UI
                    document.getElementById('waypoints-container').innerHTML = `
                         <div class="input-group" id="wp-group-0">
                            <input type="text" class="addr-input" id="startAddr" placeholder="D√©part" onchange="planTrip()">
                            <button class="input-icon-btn" onclick="locateMe('startAddr')"><span class="material-symbols-rounded">near_me</span></button>
                        </div>
                        <div class="input-group" id="wp-group-end">
                            <input type="text" class="addr-input" id="endAddr" placeholder="Destination" onchange="planTrip()">
                        </div>
                    `;
                    waypointCount = 0;

                    // Fill Start/End
                    if (data.waypoints.length > 0) document.getElementById('startAddr').value = data.waypoints[0];
                    if (data.waypoints.length > 1) document.getElementById('endAddr').value = data.waypoints[data.waypoints.length - 1];

                    // Add intermediates
                    for (let i = 1; i < data.waypoints.length - 1; i++) {
                        addWaypoint();
                        // Find the input we just added (last one before destination)
                        const container = document.getElementById('waypoints-container');
                        const groups = container.querySelectorAll('.input-group');
                        const addedInput = groups[groups.length - 2].querySelector('input'); // -1 is dest, -2 is new
                        addedInput.value = data.waypoints[i];
                    }
                }

                document.getElementById('vehicleType').value = data.vType || "sedan";
                document.getElementById('fuelType').value = data.fType || "essence";
                
                planTrip();
                updateFuelOptions(); 
                
                setTimeout(() => {
                    if(data.conso) document.getElementById('conso').value = data.conso;
                    if(data.price) document.getElementById('price').value = data.price;
                    calculate();
                }, 500);

            } catch(e) { console.error(e); alert("Fichier invalide"); }
        };
        reader.readAsText(input.files[0]);
    }

    function shareTrip() {
        const total = document.getElementById('total-val').innerText;
        const text = `üå± Eco-Drive Trajet\nCo√ªt estim√©: ${total}`;
        if (navigator.share) navigator.share({ title: 'Eco-Drive', text });
        else {
            navigator.clipboard.writeText(text);
            alert("Copi√© !");
        }
    }

    const styleTag = document.createElement('style');
    styleTag.innerHTML = `@keyframes spin { 100% { transform: rotate(360deg); } }`;
    document.head.appendChild(styleTag);

    applyPreset();
    if(window.innerWidth < 768) document.getElementById('sheet').classList.add('expanded');

</script>
</body>
</html>