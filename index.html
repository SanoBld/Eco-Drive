<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="description" content="Calculateur d'√©co-conduite intelligent avec donn√©es en temps r√©el.">
  <meta name="theme-color" id="theme-color-meta" content="#f5f7f2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Eco-Drive</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0&display=swap" />
  <link rel="manifest" href="manifest.json">
  <style>
    /* ============================================================
       CSS VARIABLES ‚Äî Light & Dark & Color Themes
    ============================================================ */
    :root {
      --primary: #006c45;
      --on-primary: #ffffff;
      --primary-container: #9ff5c6;
      --on-primary-container: #002112;
      --secondary: #4d6356;
      --on-secondary: #ffffff;
      --secondary-container: #d0e8d7;
      --on-secondary-container: #0a1f15;
      --tertiary: #3b6472;
      --tertiary-container: #bfe9fa;
      --on-tertiary-container: #001f29;
      --surface: #f5f7f2;
      --surface-dim: #d6d8d3;
      --on-surface: #181c19;
      --surface-container-lowest: #ffffff;
      --surface-container-low: #eff1ec;
      --surface-container: #e9ebe6;
      --surface-container-high: #e4e6e1;
      --surface-container-highest: #dee0db;
      --outline: #707972;
      --outline-variant: #bfc9c1;
      --error: #ba1a1a;
      --error-container: #ffdad6;
      --on-error-container: #410002;
      --scrim: rgba(0,0,0,0.45);

      --radius-xl: 32px;
      --radius-l: 20px;
      --radius-m: 14px;
      --radius-s: 8px;
      --radius-xs: 4px;
      --radius-pill: 100px;

      --shadow-1: 0 1px 4px rgba(0,0,0,0.10);
      --shadow-2: 0 2px 12px rgba(0,0,0,0.12);
      --shadow-3: 0 6px 24px rgba(0,0,0,0.14);
      --shadow-4: 0 12px 40px rgba(0,0,0,0.18);

      --ease-std: cubic-bezier(0.2, 0.0, 0, 1.0);
      --ease-exp: cubic-bezier(0.05, 0.7, 0.1, 1.0);
      --ease-overshoot: cubic-bezier(0.34, 1.56, 0.64, 1);

      --dur-s: 120ms;
      --dur-m: 220ms;
      --dur-l: 380ms;
      --dur-xl: 600ms;
    }

    /* Dark theme overrides */
    body.dark {
      --primary: #72da9f;
      --on-primary: #003823;
      --primary-container: #00522f;
      --on-primary-container: #9ff5c6;
      --secondary: #b5ccba;
      --on-secondary: #213529;
      --secondary-container: #374b3e;
      --on-secondary-container: #d0e8d7;
      --tertiary: #a3cddf;
      --tertiary-container: #1f4d5b;
      --on-tertiary-container: #bfe9fa;
      --surface: #0f1410;
      --surface-dim: #0f1410;
      --on-surface: #dfe2dd;
      --surface-container-lowest: #0a0f0b;
      --surface-container-low: #181c19;
      --surface-container: #1c201d;
      --surface-container-high: #262b27;
      --surface-container-highest: #313530;
      --outline: #89928b;
      --outline-variant: #404944;
      --error: #ffb4ab;
      --error-container: #93000a;
      --on-error-container: #ffb4ab;
    }

    /* Color themes - light */
    body.t-ocean { --primary:#006494; --on-primary:#fff; --primary-container:#c8e6ff; --on-primary-container:#001e2f; --secondary-container:#d2e4f5; }
    body.t-purple { --primary:#7135d8; --on-primary:#fff; --primary-container:#ead6ff; --on-primary-container:#27005d; --secondary-container:#e8def8; }
    body.t-sunset { --primary:#b83c00; --on-primary:#fff; --primary-container:#ffdbc9; --on-primary-container:#2d1600; --secondary-container:#ffdbc9; }
    body.t-rose { --primary:#a71554; --on-primary:#fff; --primary-container:#ffd9e2; --on-primary-container:#3e001d; --secondary-container:#ffd9e2; }

    /* Color themes - dark */
    body.dark.t-ocean { --primary:#8fd0ff; --on-primary:#00344f; --primary-container:#004a6f; }
    body.dark.t-purple { --primary:#d0baff; --on-primary:#38008b; --primary-container:#510fb3; }
    body.dark.t-sunset { --primary:#ffb68e; --on-primary:#512300; --primary-container:#7a3300; }
    body.dark.t-rose { --primary:#ffb1c8; --on-primary:#650033; --primary-container:#8d0048; }

    /* ============================================================
       GLOBAL RESET & BASE
    ============================================================ */
    *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Outfit', sans-serif;
      margin: 0;
      height: 100dvh;
      width: 100vw;
      background: var(--surface);
      color: var(--on-surface);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: background var(--dur-l) var(--ease-std), color var(--dur-l) var(--ease-std);
      color-scheme: light;
    }
    body.dark { color-scheme: dark; }

    h1, h2, h3 { margin: 0; font-family: 'Outfit', sans-serif; font-weight: 600; }
    button { font-family: 'Outfit', sans-serif; }
    input, select { font-family: 'Outfit', sans-serif; }

    /* Smooth dark mode transitions on all surface elements */
    #bottom-sheet, .nav-bar, dialog, .app-logo, .mode-badge,
    .field, .stat-tile, .fav-item, .v-card, .eco-tip,
    .trip-chip, .stats-hero, .dialog-header, .dialog-scroll,
    .result-card, .chip, .btn, .toast {
      transition-property: background, background-color, color, border-color, box-shadow;
      transition-duration: var(--dur-l);
      transition-timing-function: var(--ease-std);
    }

    /* ============================================================
       MAP
    ============================================================ */
    #map-container { position: absolute; inset: 0; z-index: 1; }
    #map { width: 100%; height: 100%; background: var(--surface-container); }
    #map.map-select-mode { cursor: crosshair; }
    .leaflet-routing-container { display: none !important; }
    .leaflet-control-zoom { display: none !important; }
    .leaflet-control-attribution { font-size: 10px !important; }

    /* Route animation ‚Äî slow, elegant */
    .route-animated {
      stroke-dasharray: 18 9;
      animation: route-flow 80s linear infinite;
    }
    @keyframes route-flow {
      to { stroke-dashoffset: -2700; }
    }

    /* ============================================================
       UI OVERLAY
    ============================================================ */
    #ui-layer {
      position: absolute;
      inset: 0;
      z-index: 2;
      pointer-events: none;
    }

    /* ============================================================
       TOP BAR
    ============================================================ */
    .top-bar {
      pointer-events: auto;
      position: absolute;
      top: 0; left: 0; right: 0;
      padding: max(env(safe-area-inset-top, 12px), 12px) 16px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      animation: slide-down var(--dur-xl) var(--ease-exp) both;
    }

    @keyframes slide-down {
      from { opacity: 0; transform: translateY(-28px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .app-logo {
      display: flex;
      align-items: center;
      gap: 9px;
      background: var(--surface-container-lowest);
      padding: 9px 16px 9px 12px;
      border-radius: var(--radius-pill);
      box-shadow: var(--shadow-2);
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--on-surface);
      backdrop-filter: blur(12px);
      transition: transform var(--dur-s), box-shadow var(--dur-s);
    }
    .app-logo:active { transform: scale(0.97); }
    .app-logo .logo-dot {
      width: 28px; height: 28px;
      background: var(--primary);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .app-logo .logo-dot .material-symbols-rounded { font-size: 16px; color: var(--on-primary); }

    /* Night mode indicator badge */
    .mode-badge {
      display: flex; align-items: center; gap: 5px;
      background: var(--surface-container-lowest);
      padding: 8px 12px;
      border-radius: var(--radius-pill);
      font-size: 0.78rem; font-weight: 500;
      box-shadow: var(--shadow-2);
      color: var(--on-surface);
    }
    .mode-badge .material-symbols-rounded { font-size: 18px; }

    /* ============================================================
       FAB STACK
    ============================================================ */
    .fab-stack {
      position: absolute;
      right: 14px;
      bottom: calc(44vh + 18px);
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: auto;
      transition: bottom var(--dur-l) var(--ease-exp);
      animation: slide-left var(--dur-xl) var(--ease-exp) 200ms both;
    }

    @keyframes slide-left {
      from { opacity: 0; transform: translateX(60px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .fab {
      width: 52px; height: 52px;
      border-radius: var(--radius-m);
      background: var(--primary-container);
      color: var(--on-primary-container);
      border: none;
      box-shadow: var(--shadow-3);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: transform var(--dur-s) var(--ease-overshoot), box-shadow var(--dur-m);
      position: relative; overflow: hidden;
    }
    .fab::after {
      content: '';
      position: absolute; inset: 0;
      background: radial-gradient(circle at center, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 100%);
      transition: background var(--dur-m);
      pointer-events: none;
    }
    .fab:active { transform: scale(0.90); box-shadow: var(--shadow-1); }
    .fab.fab-sm {
      width: 44px; height: 44px;
      border-radius: var(--radius-s);
      background: var(--surface-container-highest);
      color: var(--on-surface);
    }
    .fab .material-symbols-rounded { font-size: 22px; }

    /* ============================================================
       BOTTOM SHEET
    ============================================================ */
    #bottom-sheet {
      pointer-events: auto;
      background: var(--surface-container-lowest);
      width: 100%;
      height: 44vh;
      max-height: 91dvh;
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      box-shadow: 0 -4px 32px rgba(0,0,0,0.12);
      display: flex;
      flex-direction: column;
      transition: height var(--dur-l) var(--ease-exp);
      position: absolute;
      bottom: 0; left: 0;
      z-index: 10;
      animation: slide-up var(--dur-xl) var(--ease-exp) 300ms both;
    }

    @keyframes slide-up {
      from { opacity: 0; transform: translateY(100%); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (min-width: 780px) {
      #bottom-sheet {
        width: 420px;
        height: auto;
        max-height: 88dvh;
        left: 20px; bottom: 20px; top: 70px;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-4);
      }
      .fab-stack { right: 20px; bottom: 20px; }
    }

    .sheet-handle-wrap {
      width: 100%;
      padding: 14px 0 6px;
      display: flex; justify-content: center; align-items: center;
      cursor: grab; flex-shrink: 0;
      touch-action: none;
    }
    .sheet-handle-wrap:active { cursor: grabbing; }
    .sheet-handle {
      width: 36px; height: 4px;
      background: var(--outline-variant);
      border-radius: 2px;
      transition: width var(--dur-m), background var(--dur-m);
    }
    .sheet-handle-wrap:active .sheet-handle { width: 48px; background: var(--outline); }

    .sheet-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 0 18px 90px;
      overscroll-behavior: contain;
      scrollbar-width: thin;
      scrollbar-color: var(--outline-variant) transparent;
    }
    .sheet-scroll::-webkit-scrollbar { width: 5px; }
    .sheet-scroll::-webkit-scrollbar-thumb { background: var(--outline-variant); border-radius: 4px; }

    /* ============================================================
       NAV BAR
    ============================================================ */
    .nav-bar {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 76px;
      background: var(--surface-container-lowest);
      display: flex; justify-content: space-around; align-items: center;
      border-top: 1px solid var(--outline-variant);
      z-index: 20;
      padding-bottom: max(env(safe-area-inset-bottom, 0px), 0px);
      flex-shrink: 0;
    }

    .nav-item {
      flex: 1;
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      background: none; border: none;
      color: var(--outline);
      font-size: 0.68rem; font-weight: 500;
      cursor: pointer;
      padding: 8px 0;
      transition: color var(--dur-m);
      position: relative;
    }
    .nav-item .material-symbols-rounded {
      font-size: 22px;
      padding: 5px 18px;
      border-radius: 100px;
      transition: background var(--dur-m) var(--ease-exp), transform var(--dur-m) var(--ease-overshoot);
    }
    .nav-item.active { color: var(--on-surface); }
    .nav-item.active .material-symbols-rounded {
      background: var(--secondary-container);
      color: var(--on-secondary-container);
      transform: scale(1.05);
    }

    /* ============================================================
       TAB SECTIONS
    ============================================================ */
    .tab { display: none; }
    .tab.active {
      display: block;
      animation: fade-up var(--dur-l) var(--ease-exp) both;
    }
    @keyframes fade-up {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ============================================================
       TOOLBAR / CHIPS
    ============================================================ */
    .toolbar {
      display: flex; gap: 8px;
      overflow-x: auto; padding-bottom: 14px;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
    }
    .toolbar::-webkit-scrollbar { display: none; }

    .chip {
      display: flex; align-items: center; gap: 5px;
      padding: 7px 14px;
      border: 1.5px solid var(--outline-variant);
      border-radius: var(--radius-pill);
      background: transparent;
      color: var(--on-surface);
      font-size: 0.82rem; font-weight: 500;
      cursor: pointer; white-space: nowrap;
      transition: background var(--dur-m), border-color var(--dur-m), transform var(--dur-s);
      font-family: 'Outfit', sans-serif;
    }
    .chip .material-symbols-rounded { font-size: 17px; }
    .chip:hover { background: var(--surface-container-high); }
    .chip:active { transform: scale(0.95); background: var(--surface-container); }
    .chip.chip-active {
      background: var(--primary-container);
      border-color: var(--primary);
      color: var(--on-primary-container);
    }

    /* ============================================================
       INPUTS ‚Äî Material 3 Outlined
    ============================================================ */
    .field {
      position: relative;
      margin-bottom: 14px;
      border: 1.5px solid var(--outline);
      border-radius: var(--radius-m);
      padding: 0 12px;
      display: flex; align-items: center;
      min-height: 54px;
      background: transparent;
      transition: border-color var(--dur-m), border-width var(--dur-m), box-shadow var(--dur-m);
    }
    .field:focus-within {
      border-color: var(--primary);
      border-width: 2px;
      padding: 0 11px;
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary) 12%, transparent);
    }
    .field input, .field select {
      border: none; background: transparent;
      width: 100%; font-size: 0.95rem;
      color: var(--on-surface); outline: none;
      padding-top: 16px; padding-bottom: 4px;
      color-scheme: inherit;
    }
    .field select {
      padding-top: 0; padding-bottom: 0; cursor: pointer;
      appearance: none; -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%23707972' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0px center;
      padding-right: 22px;
      background-color: transparent;
    }
    .field label {
      position: absolute; left: 12px; top: 50%;
      transform: translateY(-50%);
      color: var(--outline); font-size: 0.95rem;
      pointer-events: none;
      transition: all var(--dur-m) var(--ease-std), background var(--dur-l);
      background: var(--surface-container-lowest);
      padding: 0 4px;
    }
    .field input:focus ~ label,
    .field input:not(:placeholder-shown) ~ label,
    .field.filled label {
      top: -1px; transform: translateY(-50%);
      font-size: 0.72rem; color: var(--primary);
    }
    .field .icon-btn {
      background: none; border: none; cursor: pointer;
      color: var(--outline); padding: 8px; margin-right: -8px;
      border-radius: 50%;
      transition: background var(--dur-s), transform var(--dur-s), color var(--dur-s);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .field .icon-btn .material-symbols-rounded { font-size: 20px; }
    .field .icon-btn:hover { background: var(--surface-container); color: var(--primary); }
    .field .icon-btn:active { transform: scale(0.88); }

    /* Autofill dark mode fix */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus {
      -webkit-text-fill-color: var(--on-surface);
      -webkit-box-shadow: 0 0 0px 1000px var(--surface-container-lowest) inset;
      transition: background-color 5000s ease-in-out 0s;
      caret-color: var(--primary);
    }
    /* Select option styling */
    .field select option {
      background: var(--surface-container-lowest);
      color: var(--on-surface);
    }
    /* Scrollbars dark mode */
    .sheet-scroll {
      scrollbar-color: var(--outline-variant) transparent;
    }

    /* ============================================================
       VEHICLE GRID
    ============================================================ */
    .vehicle-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .v-card {
      position: relative;
      border: 1.5px solid var(--outline-variant);
      border-radius: var(--radius-l);
      padding: 14px 10px 12px;
      display: flex; flex-direction: column; align-items: center; gap: 7px;
      cursor: pointer;
      transition: all var(--dur-m) var(--ease-exp);
      text-align: center; overflow: hidden;
    }
    .v-card::before {
      content: '';
      position: absolute; inset: 0;
      background: var(--secondary-container);
      opacity: 0;
      border-radius: inherit;
      transition: opacity var(--dur-m);
    }
    .v-card.selected { border-color: var(--primary); }
    .v-card.selected::before { opacity: 1; }
    .v-card .material-symbols-rounded { font-size: 26px; position: relative; z-index: 1; }
    .v-card p { margin: 0; font-size: 0.75rem; font-weight: 500; position: relative; z-index: 1; }
    .v-card:active { transform: scale(0.93); }

    /* ============================================================
       RESULT CARD
    ============================================================ */
    .result-card {
      background: var(--primary-container);
      color: var(--on-primary-container);
      border-radius: var(--radius-xl);
      padding: 28px 22px;
      text-align: center;
      margin: 6px 0 16px;
      animation: scale-in var(--dur-xl) var(--ease-exp) both;
    }
    @keyframes scale-in {
      from { opacity: 0; transform: scale(0.88); }
      to { opacity: 1; transform: scale(1); }
    }
    .price-big {
      font-size: 3.8rem; line-height: 1;
      font-weight: 700; display: block;
      letter-spacing: -1px;
    }
    .price-sub {
      font-size: 0.85rem; opacity: 0.75;
      margin-top: 6px; display: block;
    }

    /* ============================================================
       STATS GRID
    ============================================================ */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 14px;
    }
    .stat-tile {
      background: var(--surface-container);
      border-radius: var(--radius-l);
      padding: 16px 14px;
      text-align: center;
      transition: background var(--dur-m);
    }
    .stat-tile:active { background: var(--surface-container-high); }
    .stat-val {
      display: block;
      font-size: 1.45rem; font-weight: 700;
      color: var(--primary);
      font-variant-numeric: tabular-nums;
    }
    .stat-lbl {
      font-size: 0.73rem; color: var(--outline);
      margin-top: 3px; display: block;
    }

    /* ============================================================
       ACTION BUTTONS
    ============================================================ */
    .btn {
      width: 100%;
      padding: 14px 20px;
      border-radius: var(--radius-pill);
      border: none;
      font-size: 0.95rem; font-weight: 600;
      cursor: pointer;
      display: flex; justify-content: center; align-items: center; gap: 8px;
      transition: transform var(--dur-s) var(--ease-overshoot), box-shadow var(--dur-m), background var(--dur-m);
      margin-bottom: 10px;
      position: relative; overflow: hidden;
      font-family: 'Outfit', sans-serif;
    }
    .btn .material-symbols-rounded { font-size: 20px; }
    .btn-primary { background: var(--primary); color: var(--on-primary); box-shadow: var(--shadow-2); }
    .btn-primary:hover { box-shadow: var(--shadow-3); transform: translateY(-2px); }
    .btn-primary:active { transform: scale(0.97); box-shadow: var(--shadow-1); }
    .btn-primary:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }
    .btn-tonal { background: var(--secondary-container); color: var(--on-secondary-container); }
    .btn-tonal:active { transform: scale(0.97); }
    .btn-danger { background: var(--error-container); color: var(--on-error-container); }
    .btn-danger:active { transform: scale(0.97); }

    /* ============================================================
       ECO TIP
    ============================================================ */
    .eco-tip {
      margin-top: 16px;
      padding: 16px 18px;
      background: var(--tertiary-container);
      color: var(--on-tertiary-container);
      border-radius: var(--radius-l);
      animation: slide-right var(--dur-xl) var(--ease-exp) 400ms both;
    }
    @keyframes slide-right {
      from { opacity: 0; transform: translateX(24px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .eco-tip-title {
      display: flex; align-items: center; gap: 7px;
      font-size: 0.88rem; font-weight: 600;
      margin-bottom: 7px;
    }
    .eco-tip-title .material-symbols-rounded { font-size: 18px; }
    .eco-tip p { margin: 0; font-size: 0.82rem; opacity: 0.9; line-height: 1.55; }

    /* ============================================================
       DISTANCE / DURATION STRIP
    ============================================================ */
    .trip-strip {
      display: flex; gap: 8px; margin-top: 10px;
    }
    .trip-chip {
      flex: 1;
      display: flex; align-items: center; justify-content: center; gap: 6px;
      background: var(--surface-container);
      border-radius: var(--radius-m);
      padding: 10px 12px;
      font-size: 0.82rem; font-weight: 500;
    }
    .trip-chip .material-symbols-rounded { font-size: 17px; color: var(--primary); }
    .trip-chip strong { font-weight: 700; color: var(--primary); }

    /* ============================================================
       FAVORITES
    ============================================================ */
    .fav-item {
      background: var(--surface-container);
      border-radius: var(--radius-l);
      padding: 14px 14px;
      margin-bottom: 10px;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer;
      transition: background var(--dur-m), transform var(--dur-s);
    }
    .fav-item:hover { background: var(--surface-container-high); }
    .fav-item:active { transform: scale(0.98); background: var(--surface-container-high); }
    .fav-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; }
    .fav-details { font-size: 0.75rem; color: var(--outline); }
    .fav-actions { display: flex; gap: 6px; flex-shrink: 0; }

    .empty-state {
      text-align: center; padding: 44px 20px;
      color: var(--outline);
    }
    .empty-state .material-symbols-rounded { font-size: 56px; opacity: 0.4; display: block; margin-bottom: 12px; }
    .empty-state p { margin: 0; font-size: 0.88rem; line-height: 1.6; }

    /* ============================================================
       GLOBAL STATS ‚Äî Redesigned
    ============================================================ */
    .stats-hero {
      background: linear-gradient(145deg, var(--primary-container), var(--secondary-container));
      color: var(--on-primary-container);
      border-radius: var(--radius-xl);
      padding: 24px 22px 20px;
      margin-bottom: 14px;
    }
    .stats-hero-label {
      font-size: 0.78rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.8px;
      opacity: 0.7; margin-bottom: 6px;
    }
    .stats-hero-value {
      font-size: 3rem; font-weight: 700; line-height: 1;
      letter-spacing: -1px;
      margin-bottom: 14px;
    }
    .progress-track {
      height: 7px;
      background: color-mix(in srgb, var(--primary) 20%, transparent);
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: var(--primary);
      border-radius: 10px;
      transition: width 0.8s var(--ease-exp);
    }
    .progress-goal { font-size: 0.72rem; opacity: 0.6; margin-top: 5px; }

    /* ============================================================
       SETTINGS DIALOG
    ============================================================ */
    dialog {
      border: none;
      border-radius: var(--radius-xl);
      background: var(--surface-container-lowest);
      color: var(--on-surface);
      padding: 0;
      width: 92%; max-width: 420px;
      max-height: 85dvh;
      overflow: hidden;
      box-shadow: var(--shadow-4);
      animation: dialog-in var(--dur-l) var(--ease-exp);
    }
    @keyframes dialog-in {
      from { opacity: 0; transform: scale(0.88) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    dialog::backdrop {
      background: var(--scrim);
      backdrop-filter: blur(5px);
      animation: fade-in var(--dur-m);
    }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

    .dialog-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 22px 22px 0;
      position: sticky; top: 0;
      background: var(--surface-container-lowest);
      z-index: 2;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--outline-variant);
      margin-bottom: 4px;
    }
    .dialog-header h3 { font-size: 1.15rem; }
    .dialog-scroll {
      overflow-y: auto;
      padding: 12px 22px 24px;
      max-height: calc(85dvh - 70px);
      scrollbar-width: thin;
    }
    .dialog-section { margin-bottom: 22px; }
    .dialog-section h4 {
      font-size: 0.72rem; text-transform: uppercase;
      letter-spacing: 1px; color: var(--primary);
      margin-bottom: 10px; font-weight: 600;
    }
    .setting-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 9px 0;
      border-bottom: 1px solid var(--outline-variant);
    }
    .setting-row:last-child { border-bottom: none; }
    .setting-lbl { font-size: 0.88rem; }
    .setting-sub { font-size: 0.73rem; color: var(--outline); margin-top: 2px; }

    /* Toggle Switch ‚Äî Material 3 */
    .switch { position: relative; display: inline-block; width: 50px; height: 30px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; position: absolute; }
    .slider {
      position: absolute; cursor: pointer;
      inset: 0; border-radius: 100px;
      background: var(--surface-container-highest);
      border: 2px solid var(--outline);
      transition: background var(--dur-m), border-color var(--dur-m);
    }
    .slider::before {
      content: '';
      position: absolute; height: 14px; width: 14px;
      left: 6px; top: 50%; transform: translateY(-50%);
      background: var(--outline);
      border-radius: 50%;
      transition: transform var(--dur-m) var(--ease-exp), background var(--dur-m), width var(--dur-s), height var(--dur-s);
    }
    .switch input:checked + .slider { background: var(--primary); border-color: var(--primary); }
    .switch input:checked + .slider::before {
      transform: translateX(20px) translateY(-50%);
      background: var(--on-primary);
    }

    /* Color theme picker */
    .theme-row {
      display: flex; gap: 10px; flex-wrap: wrap;
      margin-top: 10px;
    }
    .theme-swatch {
      width: 44px; height: 44px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: transform var(--dur-m) var(--ease-overshoot), border-color var(--dur-m);
      position: relative; overflow: hidden;
    }
    .theme-swatch[data-t="green"]  { background: linear-gradient(135deg, #006c45, #9ff5c6); }
    .theme-swatch[data-t="ocean"]  { background: linear-gradient(135deg, #006494, #c8e6ff); }
    .theme-swatch[data-t="purple"] { background: linear-gradient(135deg, #7135d8, #ead6ff); }
    .theme-swatch[data-t="sunset"] { background: linear-gradient(135deg, #b83c00, #ffdbc9); }
    .theme-swatch[data-t="rose"]   { background: linear-gradient(135deg, #a71554, #ffd9e2); }
    .theme-swatch.active { border-color: var(--primary); transform: scale(1.15); }
    .theme-swatch.active::after {
      content: '‚úì'; position: absolute;
      inset: 0; display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 18px; color: white;
      text-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }

    /* ============================================================
       TOAST
    ============================================================ */
    .toast {
      position: fixed;
      bottom: 92px; left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--surface-container-highest);
      color: var(--on-surface);
      padding: 11px 20px;
      border-radius: var(--radius-m);
      box-shadow: var(--shadow-3);
      z-index: 9999;
      display: flex; align-items: center; gap: 8px;
      max-width: 88%; white-space: nowrap;
      font-size: 0.85rem; font-weight: 500;
      opacity: 0;
      transition: all var(--dur-m) var(--ease-exp);
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.err { background: var(--error-container); color: var(--on-error-container); }
    .toast .material-symbols-rounded { font-size: 18px; }

    /* ============================================================
       SPINNER
    ============================================================ */
    .spin {
      display: inline-block;
      width: 18px; height: 18px;
      border: 2px solid var(--outline-variant);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ============================================================
       MAP CLICK INDICATOR
    ============================================================ */
    .click-dot {
      width: 16px; height: 16px;
      background: var(--primary);
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      animation: pop 0.5s var(--ease-overshoot);
    }
    @keyframes pop {
      from { transform: scale(0); opacity: 0; }
      to   { transform: scale(1); opacity: 1; }
    }

    /* ============================================================
       CAR MARKER ‚Äî Circle, no rotation
    ============================================================ */
    .car-bubble {
      width: 40px; height: 40px;
      background: var(--primary);
      border: 3px solid white;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 3px 12px rgba(0,0,0,0.30);
      position: relative;
      animation: car-bounce 2.4s var(--ease-std) infinite;
    }
    .car-bubble::after {
      content: '';
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      border: 2px solid var(--primary);
      opacity: 0;
      animation: car-ring 2.4s ease-out infinite;
    }
    @keyframes car-bounce {
      0%, 100% { transform: translateY(0); }
      50%       { transform: translateY(-3px); }
    }
    @keyframes car-ring {
      0%   { transform: scale(0.85); opacity: 0.7; }
      100% { transform: scale(1.4);  opacity: 0; }
    }
    .car-bubble .material-symbols-rounded { font-size: 20px; color: var(--on-primary); }

    /* Start/End markers */
    .map-pin {
      width: 12px; height: 12px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    /* ============================================================
       PULSE (start marker)
    ============================================================ */
    .pulse-marker { animation: pulse-glow 2.2s ease-out infinite; }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(0,108,69,0.5), 0 2px 6px rgba(0,0,0,0.25); }
      50%       { box-shadow: 0 0 0 8px rgba(0,108,69,0),  0 2px 6px rgba(0,0,0,0.25); }
    }

    /* ============================================================
       MISC
    ============================================================ */
    #fileInput { display: none; }

    .section-title {
      font-size: 1rem; font-weight: 600;
      margin-bottom: 14px; margin-top: 2px;
    }

    .price-source {
      font-size: 0.72rem; color: var(--outline);
      text-align: center; margin-top: 6px; min-height: 16px;
    }

    /* Waypoint remove animation */
    @keyframes shrink-out {
      to { opacity: 0; transform: scaleY(0); max-height: 0; margin: 0; padding: 0; border-width: 0; }
    }
    .removing {
      animation: shrink-out 0.28s var(--ease-std) forwards;
      transform-origin: top;
    }
  </style>
</head>
<body>

<!-- Map -->
<div id="map-container">
  <div id="map"></div>
</div>

<!-- UI Overlay -->
<div id="ui-layer">
  <div class="top-bar">
    <div class="app-logo">
      <div class="logo-dot">
        <span class="material-symbols-rounded">eco</span>
      </div>
      Eco-Drive
    </div>
    <div style="display:flex;gap:8px;pointer-events:auto;">
      <div class="mode-badge" id="mode-badge">
        <span class="material-symbols-rounded" id="mode-icon">light_mode</span>
        <span id="mode-label">Jour</span>
      </div>
      <button class="fab fab-sm" onclick="openSettings()" aria-label="Param√®tres">
        <span class="material-symbols-rounded">settings</span>
      </button>
    </div>
  </div>

  <!-- FABs -->
  <div class="fab-stack">
    <button class="fab" onclick="fitRoute()" aria-label="Recentrer">
      <span class="material-symbols-rounded">crop_free</span>
    </button>
    <button class="fab" style="background:var(--tertiary-container);color:var(--on-tertiary-container);"
            onclick="locateMe('startAddr', this)" aria-label="Ma position">
      <span class="material-symbols-rounded">my_location</span>
    </button>
  </div>
</div>

<!-- Bottom Sheet -->
<div id="bottom-sheet">
  <div class="sheet-handle-wrap" id="drag-handle">
    <div class="sheet-handle"></div>
  </div>

  <div class="sheet-scroll" id="sheet-scroll">

    <!-- ‚îÄ‚îÄ TAB: TRAJET ‚îÄ‚îÄ -->
    <div id="tab-route" class="tab active">
      <div class="toolbar">
        <button class="chip" onclick="saveTrip()">
          <span class="material-symbols-rounded">save</span>Sauvegarder
        </button>
        <button class="chip" onclick="document.getElementById('fileInput').click()">
          <span class="material-symbols-rounded">upload</span>Charger
        </button>
        <button class="chip" onclick="addWaypoint()">
          <span class="material-symbols-rounded">add_location</span>√âtape
        </button>
        <button class="chip" id="map-chip" onclick="toggleMapClick()">
          <span class="material-symbols-rounded" id="map-chip-icon">touch_app</span>Clic carte
        </button>
      </div>

      <div id="wp-container">
        <div class="field filled" id="wp-start">
          <input type="text" id="startAddr" placeholder=" " oninput="onAddrInput(this)">
          <label>D√©part</label>
          <button class="icon-btn" onclick="locateMe('startAddr', this)" aria-label="Position">
            <span class="material-symbols-rounded">near_me</span>
          </button>
        </div>
        <div class="field filled" id="wp-end">
          <input type="text" id="endAddr" placeholder=" " oninput="onAddrInput(this)">
          <label>Destination</label>
          <button class="icon-btn" aria-label="Destination">
            <span class="material-symbols-rounded">flag</span>
          </button>
        </div>
      </div>

      <div class="trip-strip" id="trip-strip" style="margin-top:12px;">
        <div class="trip-chip">
          <span class="material-symbols-rounded">straighten</span>
          Distance : <strong id="dist-val">‚Äî</strong>
        </div>
        <div class="trip-chip">
          <span class="material-symbols-rounded">schedule</span>
          Dur√©e : <strong id="time-val">‚Äî</strong>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: V√âHICULE ‚îÄ‚îÄ -->
    <div id="tab-vehicle" class="tab">
      <p class="section-title">Mon V√©hicule</p>

      <div class="vehicle-grid">
        <div class="v-card selected" onclick="selectVehicle('sedan',this)" data-vt="sedan">
          <span class="material-symbols-rounded">directions_car</span><p>Berline</p>
        </div>
        <div class="v-card" onclick="selectVehicle('suv',this)" data-vt="suv">
          <span class="material-symbols-rounded">airport_shuttle</span><p>SUV</p>
        </div>
        <div class="v-card" onclick="selectVehicle('city',this)" data-vt="city">
          <span class="material-symbols-rounded">electric_car</span><p>Citadine</p>
        </div>
        <div class="v-card" onclick="selectVehicle('moto',this)" data-vt="moto">
          <span class="material-symbols-rounded">two_wheeler</span><p>Moto</p>
        </div>
        <div class="v-card" onclick="selectVehicle('van',this)" data-vt="van">
          <span class="material-symbols-rounded">local_shipping</span><p>Utilitaire</p>
        </div>
        <div class="v-card" onclick="selectVehicle('custom',this)" data-vt="custom">
          <span class="material-symbols-rounded">tune</span><p>Perso</p>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="field">
          <select id="fuelType" onchange="applyPreset()" aria-label="Carburant">
            <option value="essence">‚õΩ Essence</option>
            <option value="diesel">üõ¢Ô∏è Diesel</option>
            <option value="elec">‚ö° √âlectrique</option>
            <option value="ethanol">üåø √âthanol</option>
            <option value="gpl">üîµ GPL</option>
          </select>
        </div>
        <div class="field">
          <select id="drivingStyle" onchange="calculate()" aria-label="Style de conduite">
            <option value="1.0">üü¢ Normale</option>
            <option value="0.9">üçÉ √âco</option>
            <option value="1.15">üî¥ Sportive</option>
          </select>
        </div>
      </div>

      <div class="field filled" id="field-conso">
        <input type="number" id="conso" value="6.5" step="0.1" min="0" oninput="calculate()" placeholder=" ">
        <label id="conso-label">Conso. moyenne (L/100km)</label>
      </div>

      <div class="field filled" id="field-price">
        <input type="number" id="fuelPrice" value="1.75" step="0.01" min="0" oninput="calculate()" placeholder=" ">
        <label id="price-label">Prix carburant (‚Ç¨/L)</label>
        <button class="icon-btn" onclick="fetchFuelPrice(this)" aria-label="Actualiser">
          <span class="material-symbols-rounded" id="refresh-icon">sync</span>
        </button>
      </div>

      <p class="price-source" id="price-source"></p>

      <input type="hidden" id="vehicleType" value="sedan">
    </div>

    <!-- ‚îÄ‚îÄ TAB: R√âSULTATS ‚îÄ‚îÄ -->
    <div id="tab-result" class="tab">
      <div class="result-card">
        <span class="price-big" id="total-val">0,00 ‚Ç¨</span>
        <span class="price-sub" id="result-sub">Saisissez un trajet pour calculer</span>
      </div>

      <div class="stats-grid">
        <div class="stat-tile">
          <span class="stat-val" id="fuel-amount">‚Äî L</span>
          <span class="stat-lbl">Carburant</span>
        </div>
        <div class="stat-tile">
          <span class="stat-val" id="co2-amount">‚Äî kg</span>
          <span class="stat-lbl">CO‚ÇÇ √©mis</span>
        </div>
      </div>

      <button class="btn btn-tonal" onclick="addToFavorites()">
        <span class="material-symbols-rounded">favorite</span>
        Ajouter aux favoris
      </button>
      <button class="btn btn-primary" onclick="shareTrip()">
        <span class="material-symbols-rounded">share</span>
        Partager le r√©capitulatif
      </button>

      <div class="eco-tip">
        <div class="eco-tip-title">
          <span class="material-symbols-rounded">lightbulb</span>
          Astuce √©co
        </div>
        <p id="eco-tip-text">R√©duire la vitesse de 10 km/h sur autoroute peut √©conomiser jusqu'√† 15 % de carburant.</p>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: FAVORIS ‚îÄ‚îÄ -->
    <div id="tab-favorites" class="tab">
      <p class="section-title">Trajets favoris</p>
      <div id="favorites-list">
        <div class="empty-state">
          <span class="material-symbols-rounded">bookmark_border</span>
          <p>Aucun trajet favori<br><small>Ajoutez vos trajets r√©guliers ici</small></p>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: STATISTIQUES ‚îÄ‚îÄ -->
    <div id="tab-stats" class="tab">
      <p class="section-title">Statistiques globales</p>

      <div class="stats-hero">
        <div class="stats-hero-label">Distance totale parcourue</div>
        <div class="stats-hero-value" id="total-km">0 km</div>
        <div class="progress-track">
          <div class="progress-bar" id="km-progress" style="width:0%"></div>
        </div>
        <div class="progress-goal" id="progress-goal-lbl">Objectif : 10 000 km</div>
      </div>

      <div class="stats-grid">
        <div class="stat-tile">
          <span class="stat-val" id="total-trips">0</span>
          <span class="stat-lbl">Trajets calcul√©s</span>
        </div>
        <div class="stat-tile">
          <span class="stat-val" id="total-cost">0,00 ‚Ç¨</span>
          <span class="stat-lbl">Co√ªt total</span>
        </div>
        <div class="stat-tile">
          <span class="stat-val" id="total-fuel">0 L</span>
          <span class="stat-lbl">Carburant total</span>
        </div>
        <div class="stat-tile">
          <span class="stat-val" id="total-co2">0 kg</span>
          <span class="stat-lbl">CO‚ÇÇ total</span>
        </div>
      </div>

      <button class="btn btn-danger" onclick="resetStats()" style="margin-top:8px;">
        <span class="material-symbols-rounded">delete_forever</span>
        R√©initialiser les statistiques
      </button>
    </div>

  </div><!-- /sheet-scroll -->

  <!-- Nav Bar -->
  <nav class="nav-bar">
    <button class="nav-item active" onclick="switchTab('route')" aria-label="Trajet">
      <span class="material-symbols-rounded">map</span>Trajet
    </button>
    <button class="nav-item" onclick="switchTab('vehicle')" aria-label="V√©hicule">
      <span class="material-symbols-rounded">directions_car</span>V√©hicule
    </button>
    <button class="nav-item" onclick="switchTab('result')" aria-label="Co√ªt">
      <span class="material-symbols-rounded">payments</span>Co√ªt
    </button>
    <button class="nav-item" onclick="switchTab('favorites')" aria-label="Favoris">
      <span class="material-symbols-rounded">bookmark</span>Favoris
    </button>
    <button class="nav-item" onclick="switchTab('stats')" aria-label="Stats">
      <span class="material-symbols-rounded">analytics</span>Stats
    </button>
  </nav>
</div><!-- /bottom-sheet -->

<!-- Hidden inputs -->
<input type="hidden" id="h-distance" value="0">
<input type="hidden" id="h-duration" value="0">
<input type="file" id="fileInput" accept=".json" onchange="loadTrip(this)">

<!-- Settings Dialog -->
<dialog id="settings-dialog">
  <div class="dialog-header">
    <h3>Param√®tres</h3>
    <button onclick="document.getElementById('settings-dialog').close()"
            style="background:none;border:none;color:var(--on-surface);cursor:pointer;padding:8px;border-radius:50%;display:flex;"
            aria-label="Fermer">
      <span class="material-symbols-rounded">close</span>
    </button>
  </div>
  <div class="dialog-scroll">

    <div class="dialog-section">
      <h4>Apparence</h4>
      <div class="setting-row">
        <div>
          <div class="setting-lbl">Mode nuit</div>
          <div class="setting-sub" id="dark-mode-sub">Suit le syst√®me</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="dark-toggle" onchange="onDarkToggle()">
          <span class="slider"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-lbl">Suivre le syst√®me</div>
          <div class="setting-sub">Activer/d√©sactiver le mode auto</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="auto-dark-toggle" checked onchange="onAutoDarkToggle()">
          <span class="slider"></span>
        </label>
      </div>
      <div class="setting-row" style="flex-direction:column;align-items:flex-start;gap:10px;">
        <div class="setting-lbl">Th√®me de couleur</div>
        <div class="theme-row">
          <div class="theme-swatch active" data-t="green"  onclick="setColorTheme('green')"></div>
          <div class="theme-swatch" data-t="ocean"  onclick="setColorTheme('ocean')"></div>
          <div class="theme-swatch" data-t="purple" onclick="setColorTheme('purple')"></div>
          <div class="theme-swatch" data-t="sunset" onclick="setColorTheme('sunset')"></div>
          <div class="theme-swatch" data-t="rose"   onclick="setColorTheme('rose')"></div>
        </div>
      </div>
    </div>

    <div class="dialog-section">
      <h4>Carte</h4>
      <div class="setting-row">
        <div><div class="setting-lbl">Vue satellite</div><div class="setting-sub">Fond satellite au lieu de la carte</div></div>
        <label class="switch"><input type="checkbox" id="sat-toggle" onchange="toggleSatellite()"><span class="slider"></span></label>
      </div>
      <div class="setting-row">
        <div><div class="setting-lbl">Clic sur la carte</div><div class="setting-sub">Ajouter des points en cliquant</div></div>
        <label class="switch"><input type="checkbox" id="map-click-settings" onchange="toggleMapClick(true)"><span class="slider"></span></label>
      </div>
      <div class="setting-row">
        <div><div class="setting-lbl">Zoom automatique</div><div class="setting-sub">Ajuster la vue apr√®s calcul</div></div>
        <label class="switch"><input type="checkbox" id="auto-zoom" checked><span class="slider"></span></label>
      </div>
    </div>

    <div class="dialog-section">
      <h4>Animations</h4>
      <div class="setting-row">
        <div><div class="setting-lbl">Voiture anim√©e</div><div class="setting-sub">Marqueur voiture sur le trajet</div></div>
        <label class="switch"><input type="checkbox" id="car-anim" checked><span class="slider"></span></label>
      </div>
      <div class="setting-row">
        <div><div class="setting-lbl">Trac√© anim√©</div><div class="setting-sub">Ligne d'itin√©raire en mouvement</div></div>
        <label class="switch"><input type="checkbox" id="route-anim" checked onchange="onRouteAnimToggle()"><span class="slider"></span></label>
      </div>
      <div class="setting-row">
        <div><div class="setting-lbl">Vibrations</div><div class="setting-sub">Retour haptique sur mobile</div></div>
        <label class="switch"><input type="checkbox" id="haptic-toggle" checked><span class="slider"></span></label>
      </div>
    </div>

    <div class="dialog-section">
      <h4>Calculs</h4>
      <div class="setting-row">
        <div><div class="setting-lbl">Prix auto au d√©marrage</div><div class="setting-sub">Actualiser √† l'ouverture</div></div>
        <label class="switch"><input type="checkbox" id="auto-price" checked><span class="slider"></span></label>
      </div>
      <div class="setting-row">
        <div><div class="setting-lbl">Afficher le CO‚ÇÇ</div><div class="setting-sub">Impact environnemental</div></div>
        <label class="switch"><input type="checkbox" id="show-co2" checked onchange="calculate()"><span class="slider"></span></label>
      </div>
    </div>

    <div class="dialog-section">
      <h4>Donn√©es</h4>
      <div class="setting-row">
        <div><div class="setting-lbl">Sauvegarder l'historique</div><div class="setting-sub">Enregistrer les statistiques</div></div>
        <label class="switch"><input type="checkbox" id="history-toggle" checked><span class="slider"></span></label>
      </div>
      <div class="setting-row">
        <div><div class="setting-lbl">G√©olocalisation</div><div class="setting-sub">Autoriser la position GPS</div></div>
        <label class="switch"><input type="checkbox" id="geo-toggle" checked><span class="slider"></span></label>
      </div>
    </div>

    <p style="font-size:0.72rem;color:var(--outline);text-align:center;margin-top:10px;line-height:1.7;">
      Eco-Drive ¬∑ OpenStreetMap &amp; OSRM<br>
      Donn√©es carburant : data.gouv.fr<br>
      ¬© 2025
    </p>
  </div>
</dialog>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
<script>
'use strict';
/* ================================================================
   STORAGE HELPERS
================================================================ */
const SK = {
  DARK:'ed_dark', AUTO_DARK:'ed_auto_dark', COLOR:'ed_color',
  SETTINGS:'ed_settings', FAVORITES:'ed_favs', STATS:'ed_stats', VEHICLE:'ed_vehicle'
};

function stor(key, val) {
  try { localStorage.setItem(key, JSON.stringify(val)); return true; }
  catch(e) { return false; }
}
function load(key, def=null) {
  try { const v=localStorage.getItem(key); return v!==null ? JSON.parse(v) : def; }
  catch(e) { return def; }
}

/* ================================================================
   HAPTIC
================================================================ */
function haptic(type='light') {
  if (!document.getElementById('haptic-toggle').checked) return;
  const p={light:10,medium:20,heavy:35,success:[10,50,10],error:[20,100,20]};
  if (navigator.vibrate) navigator.vibrate(p[type]||10);
}

/* ================================================================
   TOAST
================================================================ */
let _toastTimer;
function toast(msg, isErr=false) {
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  clearTimeout(_toastTimer);
  const t=document.createElement('div');
  t.className='toast'+(isErr?' err':'');
  t.innerHTML=`<span class="material-symbols-rounded">${isErr?'error':'check_circle'}</span>${msg}`;
  document.body.appendChild(t);
  requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ t.classList.add('show'); }); });
  _toastTimer=setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300); },3000);
  haptic(isErr?'error':'light');
}

/* ================================================================
   DARK MODE ‚Äî Auto + Manual
================================================================ */
let _autoDark = load(SK.AUTO_DARK, true);
let _manualDark = load(SK.DARK, null); // null = not set

const sysDark = window.matchMedia('(prefers-color-scheme: dark)');

function applyDark(dark) {
  document.body.classList.toggle('dark', dark);
  document.getElementById('dark-toggle').checked = dark;
  // Update meta theme color
  const metaColor = dark ? '#0f1410' : '#f5f7f2';
  document.getElementById('theme-color-meta').setAttribute('content', metaColor);
  // Update badge
  document.getElementById('mode-icon').textContent = dark ? 'dark_mode' : 'light_mode';
  document.getElementById('mode-label').textContent = dark ? 'Nuit' : 'Jour';
  // Remap tiles
  refreshTiles();
}

function resolveDark() {
  if (_autoDark) {
    return sysDark.matches;
  }
  return _manualDark === true;
}

function onDarkToggle() {
  if (document.getElementById('auto-dark-toggle').checked) {
    // Disable auto if user manually toggles
    document.getElementById('auto-dark-toggle').checked = false;
    _autoDark = false;
    stor(SK.AUTO_DARK, false);
    document.getElementById('dark-mode-sub').textContent = 'Manuel';
  }
  _manualDark = document.getElementById('dark-toggle').checked;
  stor(SK.DARK, _manualDark);
  applyDark(_manualDark);
  haptic('medium');
  toast('Th√®me ' + (_manualDark ? 'sombre' : 'clair') + ' activ√©');
}

function onAutoDarkToggle() {
  _autoDark = document.getElementById('auto-dark-toggle').checked;
  stor(SK.AUTO_DARK, _autoDark);
  document.getElementById('dark-mode-sub').textContent = _autoDark ? 'Suit le syst√®me' : 'Manuel';
  if (_autoDark) {
    applyDark(sysDark.matches);
    haptic('medium');
    toast('Mode auto activ√©');
  }
}

// Watch system changes
sysDark.addEventListener('change', e => {
  if (_autoDark) { applyDark(e.matches); }
});

/* ================================================================
   COLOR THEMES
================================================================ */
let _colorTheme = 'green';
function setColorTheme(t) {
  _colorTheme = t;
  document.querySelectorAll('.theme-swatch').forEach(s=>s.classList.remove('active'));
  document.querySelector(`[data-t="${t}"]`)?.classList.add('active');
  document.body.className = document.body.className
    .replace(/\bt-\w+\b/g,'')
    .replace(/dark\b/,'') // preserve
    .trim();
  // Re-apply dark
  if (document.body.classList.contains('dark') || resolveDark()) {
    document.body.classList.add('dark');
  }
  if (t !== 'green') document.body.classList.add('t-'+t);
  stor(SK.COLOR, t);
  refreshTiles();
  haptic('medium');
  toast('Th√®me activ√©');
}

/* ================================================================
   MAP
================================================================ */
const map = L.map('map', { zoomControl:false, attributionControl:false })
              .setView([46.6, 1.88], 6);

L.control.attribution({ position:'topright', prefix:false }).addTo(map);

const TILES = {
  light: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
  dark:  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  sat:   'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
};
let _tile = null;

function refreshTiles() {
  const isDark = document.body.classList.contains('dark');
  const isSat  = document.getElementById('sat-toggle').checked;
  const url = isSat ? TILES.sat : (isDark ? TILES.dark : TILES.light);
  if (_tile) map.removeLayer(_tile);
  _tile = L.tileLayer(url, {
    attribution:'&copy; <a href="https://carto.com">CARTO</a> / <a href="https://osm.org">OSM</a>',
    maxZoom: 19
  }).addTo(map);
}

function toggleSatellite() {
  haptic('medium');
  refreshTiles();
  saveSettings();
  toast('Vue ' + (document.getElementById('sat-toggle').checked ? 'satellite' : 'carte') + ' activ√©e');
}

/* ================================================================
   MAP CLICK
================================================================ */
let _mapClickOn = false;

function syncMapClickUI() {
  const on = _mapClickOn;
  document.getElementById('map-chip-icon').textContent = on ? 'cancel' : 'touch_app';
  document.getElementById('map-chip').classList.toggle('chip-active', on);
  document.getElementById('map-click-settings').checked = on;
  document.getElementById('map').classList.toggle('map-select-mode', on);
}

function toggleMapClick(fromSettings) {
  if (fromSettings) {
    // Called from settings toggle ‚Äî read its state
    _mapClickOn = document.getElementById('map-click-settings').checked;
  } else {
    // Called from chip ‚Äî toggle and sync settings
    _mapClickOn = !_mapClickOn;
    document.getElementById('map-click-settings').checked = _mapClickOn;
  }
  syncMapClickUI();
  if (_mapClickOn) toast('Cliquez sur la carte pour placer un point');
  else toast('Clic carte d√©sactiv√©');
  haptic('medium');
}

map.on('click', async (e) => {
  if (!_mapClickOn) return;
  haptic('light');

  const dot = L.marker(e.latlng, {
    icon: L.divIcon({ className:'click-dot', iconSize:[16,16], iconAnchor:[8,8] })
  }).addTo(map);
  setTimeout(() => map.removeLayer(dot), 700);

  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
    const d = await r.json();
    const name = d.display_name || `${e.latlng.lat.toFixed(5)},${e.latlng.lng.toFixed(5)}`;
    const start = document.getElementById('startAddr');
    const end   = document.getElementById('endAddr');
    if (!start.value) {
      setInputVal(start, name);
    } else if (!end.value) {
      setInputVal(end, name);
      // Disable map click after both filled
      _mapClickOn = false;
      syncMapClickUI();
    } else {
      addWaypoint();
      setTimeout(() => {
        const wps = document.querySelectorAll('#wp-container input[type="text"]');
        const last = wps[wps.length - 2]; // last before endAddr
        if (last) { setInputVal(last, name); }
      }, 80);
    }
    debounce_planTrip();
  } catch(err) {
    toast('Impossible de r√©cup√©rer l\'adresse', true);
  }
});

function setInputVal(input, val) {
  input.value = val;
  input.parentElement.classList.add('filled');
}

/* ================================================================
   WAYPOINTS
================================================================ */
let _wpCount = 0;

function onAddrInput(input) {
  const hasVal = input.value.trim().length > 0;
  input.parentElement.classList.toggle('filled', hasVal);
  debounce_planTrip();
}

let _planTimer = null;
function debounce_planTrip() {
  clearTimeout(_planTimer);
  _planTimer = setTimeout(planTrip, 900);
}

function addWaypoint() {
  haptic('light');
  _wpCount++;
  const n = _wpCount;
  const end = document.getElementById('wp-end');
  const div = document.createElement('div');
  div.className = 'field';
  div.id = `wp-${n}`;
  div.innerHTML = `
    <input type="text" placeholder=" " oninput="onAddrInput(this)">
    <label>√âtape ${n}</label>
    <button class="icon-btn" onclick="removeWaypoint(${n})" style="color:var(--error);" aria-label="Supprimer">
      <span class="material-symbols-rounded">delete</span>
    </button>`;
  document.getElementById('wp-container').insertBefore(div, end);
  toast('√âtape ajout√©e');
}

function removeWaypoint(id) {
  haptic('medium');
  const el = document.getElementById(`wp-${id}`);
  if (!el) return;
  el.classList.add('removing');
  setTimeout(() => { el.remove(); planTrip(); toast('√âtape supprim√©e'); }, 300);
}

/* ================================================================
   GEOLOCATION
================================================================ */
function locateMe(inputId, btn) {
  if (!document.getElementById('geo-toggle').checked) {
    toast('G√©olocalisation d√©sactiv√©e dans les param√®tres', true); return;
  }
  if (!navigator.geolocation) { toast('G√©olocalisation non support√©e', true); return; }
  haptic('light');

  const origInner = btn.innerHTML;
  btn.innerHTML = '<div class="spin"></div>';
  btn.disabled = true;

  navigator.geolocation.getCurrentPosition(
    async pos => {
      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
        const d = await r.json();
        const a = d.address || {};
        const short = [a.road||a.hamlet||a.village, a.city||a.town||a.municipality].filter(Boolean).join(', ') || d.display_name;
        const inp = document.getElementById(inputId);
        setInputVal(inp, short);
        map.setView([pos.coords.latitude, pos.coords.longitude], 13);
        planTrip();
        toast('Position d√©tect√©e');
        haptic('success');
      } catch(e) {
        const inp = document.getElementById(inputId);
        setInputVal(inp, `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`);
        planTrip();
        toast('Position d√©tect√©e');
      } finally {
        btn.innerHTML = origInner;
        btn.disabled = false;
      }
    },
    err => {
      btn.innerHTML = origInner;
      btn.disabled = false;
      toast('Impossible de vous g√©olocaliser', true);
      haptic('error');
    },
    { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
  );
}

/* ================================================================
   ROUTING
================================================================ */
let _routeCtrl = null;
let _carMarker = null;
let _animId    = null;
let _routeCoords = null;

async function planTrip() {
  const inputs = document.querySelectorAll('#wp-container input[type="text"]');
  const addrs = Array.from(inputs).map(i => i.value.trim()).filter(Boolean);
  if (addrs.length < 2) return;

  // Clean previous
  if (_routeCtrl) { map.removeControl(_routeCtrl); _routeCtrl = null; }
  if (_carMarker) { map.removeLayer(_carMarker); _carMarker = null; }
  if (_animId)    { cancelAnimationFrame(_animId); _animId = null; }

  document.getElementById('dist-val').innerHTML = '<span class="spin"></span>';
  document.getElementById('time-val').innerHTML = '<span class="spin"></span>';

  // Geocode all addresses
  let coords;
  try {
    const promises = addrs.map(addr =>
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`)
        .then(r => r.json())
        .then(d => d[0] ? L.latLng(+d[0].lat, +d[0].lon) : null)
        .catch(() => null)
    );
    coords = await Promise.all(promises);
    if (coords.some(c => c === null)) {
      toast('Certaines adresses sont introuvables', true);
      document.getElementById('dist-val').textContent = '‚Äî';
      document.getElementById('time-val').textContent = '‚Äî';
      return;
    }
  } catch(e) {
    toast('Erreur r√©seau lors du g√©ocodage', true);
    document.getElementById('dist-val').textContent = '‚Äî';
    document.getElementById('time-val').textContent = '‚Äî';
    return;
  }

  const routeAnim = document.getElementById('route-anim').checked;
  const primaryColor = getComputedStyle(document.body).getPropertyValue('--primary').trim() || '#006c45';

  _routeCtrl = L.Routing.control({
    waypoints: coords,
    router: L.Routing.osrmv1({ serviceUrl:'https://router.project-osrm.org/route/v1' }),
    lineOptions: {
      styles: [{
        color: primaryColor, weight: 5, opacity: 0.82,
        className: routeAnim ? 'route-animated' : ''
      }]
    },
    createMarker(i, wp, n) {
      const isStart = i === 0, isEnd = i === n-1;
      const bg = isStart ? primaryColor : (isEnd ? '#ba1a1a' : '#888');
      const cls = isStart ? 'map-pin pulse-marker' : 'map-pin';
      return L.marker(wp.latLng, {
        draggable: true,
        icon: L.divIcon({
          className: cls,
          html: `<div style="width:12px;height:12px;background:${bg};border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.25);"></div>`,
          iconSize:[12,12], iconAnchor:[6,6]
        })
      }).on('dragend', () => { haptic('medium'); planTrip(); });
    },
    addWaypoints: false, show: false
  })
  .on('routesfound', e => {
    const route = e.routes[0];
    _routeCoords = route.coordinates;
    const km  = (route.summary.totalDistance / 1000).toFixed(1);
    const min = Math.round(route.summary.totalTime / 60);

    document.getElementById('h-distance').value = km;
    document.getElementById('h-duration').value = min;
    document.getElementById('dist-val').textContent = km + ' km';
    document.getElementById('time-val').textContent = min + ' min';

    calculate();
    refreshEcoTip(parseFloat(km));

    if (document.getElementById('auto-zoom').checked) {
      setTimeout(fitRoute, 150);
    }
    if (document.getElementById('car-anim').checked) {
      setTimeout(() => animateCar(_routeCoords), 400);
    }
    haptic('success');
  })
  .on('routingerror', () => {
    toast('Calcul de l\'itin√©raire impossible', true);
    document.getElementById('dist-val').textContent = '‚Äî';
    document.getElementById('time-val').textContent = '‚Äî';
  })
  .addTo(map);
}

function onRouteAnimToggle() {
  if (_routeCtrl) planTrip(); // redraw
  saveSettings();
}

function fitRoute() {
  if (!_routeCtrl) return;
  const wps = _routeCtrl.getWaypoints().filter(w => w.latLng);
  if (wps.length < 2) return;
  const bounds = L.latLngBounds(wps.map(w => w.latLng));
  map.fitBounds(bounds, {
    padding: [50,50],
    paddingBottomRight: window.innerWidth < 780 ? [50, 340] : [50,50],
    maxZoom: 15
  });
}

/* ================================================================
   CAR ANIMATION ‚Äî Circle marker, constant-speed distance-based
================================================================ */
function animateCar(coords) {
  if (!coords || coords.length < 2) return;
  if (_carMarker) { map.removeLayer(_carMarker); _carMarker = null; }
  if (_animId)    { cancelAnimationFrame(_animId); _animId = null; }

  const primaryColor = getComputedStyle(document.body).getPropertyValue('--primary').trim() || '#006c45';
  const onPrimary    = getComputedStyle(document.body).getPropertyValue('--on-primary').trim() || '#ffffff';

  const icon = L.divIcon({
    html: `<div class="car-bubble" style="background:${primaryColor};border-color:white;">
             <span class="material-symbols-rounded" style="color:${onPrimary};font-size:20px;">directions_car</span>
           </div>`,
    className: '',
    iconSize: [40,40],
    iconAnchor: [20,20]
  });

  _carMarker = L.marker(coords[0], { icon, zIndexOffset:999 }).addTo(map);

  // Pre-compute cumulative distances along polyline for constant-speed movement
  const cumDist = [0];
  for (let i = 1; i < coords.length; i++) {
    const dlat = coords[i].lat - coords[i-1].lat;
    const dlng = coords[i].lng - coords[i-1].lng;
    cumDist.push(cumDist[i-1] + Math.sqrt(dlat*dlat + dlng*dlng));
  }
  const totalDist = cumDist[cumDist.length - 1];

  // Loop duration: min 14s, grows with route length
  const LOOP_MS = Math.max(coords.length * 35, 14000);

  let startTs = null;
  let lastIdx  = 0; // cache for forward-scan optimisation

  function step(ts) {
    if (!startTs) startTs = ts;
    const elapsed = (ts - startTs) % LOOP_MS;
    // Reset index at loop restart
    if (elapsed < 50) lastIdx = 0;
    const target = (elapsed / LOOP_MS) * totalDist;

    // Forward scan from lastIdx (amortised O(1) for sequential access)
    while (lastIdx < cumDist.length - 2 && cumDist[lastIdx + 1] <= target) lastIdx++;

    const i   = Math.min(lastIdx, coords.length - 2);
    const seg = cumDist[i + 1] - cumDist[i];
    const t   = seg > 1e-10 ? (target - cumDist[i]) / seg : 0;

    const c1 = coords[i];
    const c2 = coords[i + 1];
    _carMarker.setLatLng([
      c1.lat + (c2.lat - c1.lat) * t,
      c1.lng + (c2.lng - c1.lng) * t
    ]);

    _animId = requestAnimationFrame(step);
  }

  _animId = requestAnimationFrame(step);
}

/* ================================================================
   VEHICLE PRESETS
================================================================ */
const PRESETS = {
  sedan:  { essence:6.8, diesel:5.5, elec:16.0, ethanol:8.5, gpl:8.2 },
  suv:    { essence:8.5, diesel:7.0, elec:20.0, ethanol:10.5,gpl:10.0 },
  city:   { essence:5.2, diesel:4.2, elec:13.5, ethanol:6.5, gpl:6.5 },
  moto:   { essence:4.0, diesel:3.5, elec:8.0,  ethanol:5.0, gpl:5.0 },
  van:    { essence:10.0,diesel:8.0, elec:24.0, ethanol:12.0,gpl:12.0 },
  custom: {}
};
const CO2 = { essence:2.31, diesel:2.65, elec:0, ethanol:1.5, gpl:1.63 };

function selectVehicle(type, el) {
  haptic('light');
  document.querySelectorAll('.v-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('vehicleType').value = type;
  applyPreset();
  saveVehicle();
}

function applyPreset() {
  const vt = document.getElementById('vehicleType').value;
  const ft = document.getElementById('fuelType').value;
  const isElec = ft === 'elec';
  document.getElementById('conso-label').textContent = isElec ? 'Conso. (kWh/100km)' : 'Conso. moyenne (L/100km)';
  document.getElementById('price-label').textContent = isElec ? 'Prix (‚Ç¨/kWh)' : 'Prix carburant (‚Ç¨/L)';
  if (vt !== 'custom' && PRESETS[vt]?.[ft] !== undefined) {
    document.getElementById('conso').value = PRESETS[vt][ft];
    document.getElementById('field-conso').classList.add('filled');
  }
  if (document.getElementById('auto-price').checked) {
    fetchFuelPrice(document.getElementById('refresh-icon'));
  } else {
    calculate();
  }
}

/* ================================================================
   CALCULATION
================================================================ */
function calculate() {
  const d  = parseFloat(document.getElementById('h-distance').value) || 0;
  const c  = parseFloat(document.getElementById('conso').value) || 0;
  const p  = parseFloat(document.getElementById('fuelPrice').value) || 0;
  const sf = parseFloat(document.getElementById('drivingStyle').value) || 1.0;
  const ft = document.getElementById('fuelType').value;

  const fuelUsed = d * (c / 100) * sf;
  const total    = fuelUsed * p;
  const co2kg    = ft === 'elec' ? 0 : fuelUsed * (CO2[ft] || 2.31);
  const showCO2  = document.getElementById('show-co2').checked;

  animateNumber(document.getElementById('total-val'), total, '‚Ç¨', v => v.toFixed(2).replace('.',',') + ' ‚Ç¨');
  document.getElementById('fuel-amount').textContent = ft === 'elec'
    ? fuelUsed.toFixed(1) + ' kWh'
    : fuelUsed.toFixed(1) + ' L';
  document.getElementById('co2-amount').textContent  = showCO2 ? co2kg.toFixed(1) + ' kg' : 'N/A';

  const styleOpt = document.getElementById('drivingStyle').selectedOptions[0].text.replace(/^[^ ]+ /,'');
  document.getElementById('result-sub').textContent = d > 0
    ? `${d} km ¬∑ Conduite ${styleOpt}`
    : 'Saisissez un trajet pour calculer';
}

let _numTimers = {};
function animateNumber(el, targetVal, _unused, fmt) {
  const id = el.id;
  clearInterval(_numTimers[id]);
  let cur = parseFloat(el.textContent.replace(',','.').replace(/[^0-9.]/g,'')) || 0;
  if (Math.abs(cur - targetVal) < 0.001) { el.textContent = fmt(targetVal); return; }
  const step = (targetVal - cur) / 16;
  _numTimers[id] = setInterval(() => {
    cur += step;
    if ((step>0 && cur>=targetVal)||(step<0 && cur<=targetVal)) {
      cur = targetVal; clearInterval(_numTimers[id]);
    }
    el.textContent = fmt(cur);
  }, 16);
}

/* ================================================================
   FUEL PRICE API
================================================================ */
async function fetchFuelPrice(btnOrIcon) {
  haptic('light');
  const icon = (btnOrIcon instanceof HTMLElement && btnOrIcon.classList.contains('material-symbols-rounded'))
    ? btnOrIcon
    : document.getElementById('refresh-icon');

  icon.style.animation = 'spin 0.7s linear infinite';

  const ft = document.getElementById('fuelType').value;

  const fallback = { essence:1.85, diesel:1.72, ethanol:0.89, gpl:1.05, elec:0.2276 };

  try {
    if (ft === 'elec') {
      document.getElementById('fuelPrice').value = '0.2276';
      document.getElementById('field-price').classList.add('filled');
      document.getElementById('price-source').textContent = 'Tarif r√©glement√© EDF 2025';
      calculate();
    } else {
      const map2 = { essence:'sp95_prix', diesel:'gazole_prix', ethanol:'e85_prix', gpl:'gplc_prix' };
      const fld  = map2[ft] || 'sp95_prix';
      const resp = await fetch(
        `https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/prix-des-carburants-en-france-flux-instantane-v2/records?select=${fld}&where=${fld}%20IS%20NOT%20NULL&limit=100`,
        { signal: AbortSignal.timeout(8000) }
      );
      if (!resp.ok) throw new Error('API error');
      const data = await resp.json();
      const rawPrices = (data.results || [])
        .map(r => parseFloat(r[fld]))
        .filter(v => !isNaN(v) && v > 0);
      // API may return values in millicentimes (e.g. 1850) or euros (e.g. 1.850)
      const prices = rawPrices.map(v => v > 20 ? v / 1000 : v).filter(v => v > 0.5 && v < 5);
      if (prices.length > 5) {
        const avg = prices.reduce((a,b)=>a+b,0) / prices.length;
        document.getElementById('fuelPrice').value = avg.toFixed(3);
        document.getElementById('field-price').classList.add('filled');
        document.getElementById('price-source').textContent = `Moyenne ${prices.length} stations ¬∑ France`;
        calculate();
        toast('Prix actualis√©');
        haptic('success');
      } else throw new Error('Not enough data');
    }
  } catch(e) {
    if (fallback[ft]) {
      document.getElementById('fuelPrice').value = fallback[ft].toFixed(ft==='elec'?4:2);
      document.getElementById('field-price').classList.add('filled');
      document.getElementById('price-source').textContent = 'Prix indicatif 2025';
      calculate();
    }
  } finally {
    icon.style.animation = '';
  }
}

/* ================================================================
   ECO TIPS
================================================================ */
const TIPS = [
  'R√©duire la vitesse de 10 km/h sur autoroute √©conomise jusqu\'√† 15 % de carburant.',
  'Anticiper le trafic et √©viter les freinages brusques r√©duit la consommation de 20 %.',
  'Une pression correcte des pneus am√©liore l\'efficacit√© √©nerg√©tique de 3 %.',
  'Limiter la climatisation peut r√©duire la consommation de 10 √† 15 %.',
  'Couper le moteur d√®s 20 secondes d\'arr√™t permet d\'√©conomiser du carburant.',
  'Le r√©gulateur de vitesse optimise la consommation sur route.',
  '√âviter les heures de pointe r√©duit √† la fois le temps et le carburant.',
  'Acc√©l√©rer progressivement √©conomise jusqu\'√† 10 % de carburant.',
  'Retirer les coffres de toit diminue la r√©sistance a√©rodynamique.',
  'Un entretien r√©gulier maintient une consommation optimale.'
];

function refreshEcoTip(km) {
  const idx = km > 100 ? 0 : Math.floor(Math.random() * TIPS.length);
  document.getElementById('eco-tip-text').textContent = TIPS[idx];
}

/* ================================================================
   FAVORITES
================================================================ */
function addToFavorites() {
  haptic('medium');
  const inputs = document.querySelectorAll('#wp-container input[type="text"]');
  const addrs = Array.from(inputs).map(i => i.value.trim()).filter(Boolean);
  if (addrs.length < 2) { toast('Planifiez d\'abord un trajet', true); return; }

  const name = prompt('Nom du trajet :', addrs[0].split(',')[0] + ' ‚Üí ' + addrs[addrs.length-1].split(',')[0]);
  if (!name) return;

  const fav = {
    id: Date.now(), name,
    waypoints: addrs,
    distance: document.getElementById('h-distance').value,
    cost: document.getElementById('total-val').textContent,
    fuel: document.getElementById('fuel-amount').textContent,
    vehicle: {
      type:     document.getElementById('vehicleType').value,
      fuelType: document.getElementById('fuelType').value,
      conso:    document.getElementById('conso').value,
      price:    document.getElementById('fuelPrice').value,
      style:    document.getElementById('drivingStyle').value
    },
    createdAt: new Date().toISOString()
  };

  const favs = load(SK.FAVORITES, []);
  favs.unshift(fav);
  stor(SK.FAVORITES, favs);
  toast('Trajet ajout√© aux favoris');
  haptic('success');
}

function renderFavorites() {
  const favs = load(SK.FAVORITES, []);
  const el = document.getElementById('favorites-list');
  if (!favs.length) {
    el.innerHTML = `<div class="empty-state">
      <span class="material-symbols-rounded">bookmark_border</span>
      <p>Aucun trajet favori<br><small>Ajoutez vos trajets r√©guliers ici</small></p>
    </div>`;
    return;
  }
  el.innerHTML = favs.map(f => `
    <div class="fav-item">
      <div style="flex:1;min-width:0;">
        <div class="fav-name">${f.name}</div>
        <div class="fav-details">${f.distance} km ¬∑ ${f.cost} ¬∑ ${f.fuel}</div>
      </div>
      <div class="fav-actions">
        <button class="icon-btn" onclick="loadFavorite(${f.id})" style="color:var(--primary);" aria-label="Charger">
          <span class="material-symbols-rounded">directions</span>
        </button>
        <button class="icon-btn" onclick="deleteFavorite(${f.id})" style="color:var(--error);" aria-label="Supprimer">
          <span class="material-symbols-rounded">delete</span>
        </button>
      </div>
    </div>`).join('');
}

function loadFavorite(id) {
  haptic('medium');
  const favs = load(SK.FAVORITES, []);
  const f = favs.find(x => x.id === id);
  if (!f) return;

  // Reset waypoints
  document.getElementById('wp-container').innerHTML = `
    <div class="field filled" id="wp-start">
      <input type="text" id="startAddr" placeholder=" " oninput="onAddrInput(this)">
      <label>D√©part</label>
      <button class="icon-btn" onclick="locateMe('startAddr',this)" aria-label="Position">
        <span class="material-symbols-rounded">near_me</span>
      </button>
    </div>
    <div class="field filled" id="wp-end">
      <input type="text" id="endAddr" placeholder=" " oninput="onAddrInput(this)">
      <label>Destination</label>
      <button class="icon-btn" aria-label="Destination">
        <span class="material-symbols-rounded">flag</span>
      </button>
    </div>`;
  _wpCount = 0;

  document.getElementById('startAddr').value = f.waypoints[0];
  document.getElementById('endAddr').value   = f.waypoints[f.waypoints.length - 1];

  for (let i = 1; i < f.waypoints.length - 1; i++) {
    addWaypoint();
    setTimeout(() => {
      const wps = document.querySelectorAll('#wp-container input[type="text"]');
      const t = wps[wps.length - 2];
      if (t) { t.value = f.waypoints[i]; t.parentElement.classList.add('filled'); }
    }, 60);
  }

  // Vehicle
  const vcard = document.querySelector(`[data-vt="${f.vehicle.type}"]`);
  if (vcard) { document.querySelectorAll('.v-card').forEach(c=>c.classList.remove('selected')); vcard.classList.add('selected'); document.getElementById('vehicleType').value = f.vehicle.type; }
  document.getElementById('fuelType').value    = f.vehicle.fuelType || 'essence';
  document.getElementById('drivingStyle').value= f.vehicle.style    || '1.0';
  setTimeout(() => {
    document.getElementById('conso').value    = f.vehicle.conso;
    document.getElementById('fuelPrice').value= f.vehicle.price;
    document.getElementById('field-conso').classList.add('filled');
    document.getElementById('field-price').classList.add('filled');
    planTrip();
    switchTab('route');
    toast('Trajet favori charg√©');
  }, 150);
}

function deleteFavorite(id) {
  if (!confirm('Supprimer ce favori ?')) return;
  haptic('heavy');
  stor(SK.FAVORITES, load(SK.FAVORITES,[]).filter(f=>f.id!==id));
  renderFavorites();
  toast('Favori supprim√©');
}

/* ================================================================
   STATISTICS
================================================================ */
function updateStats() {
  if (!document.getElementById('history-toggle').checked) return;
  const d  = parseFloat(document.getElementById('h-distance').value) || 0;
  if (d === 0) return;
  const cost = parseFloat(document.getElementById('total-val').textContent.replace(',','.').replace(/[^0-9.]/g,'')) || 0;
  const fuel = parseFloat(document.getElementById('fuel-amount').textContent) || 0;
  const co2  = parseFloat(document.getElementById('co2-amount').textContent) || 0;
  const s = load(SK.STATS, { km:0, trips:0, cost:0, fuel:0, co2:0 });
  s.km += d; s.trips++; s.cost += cost; s.fuel += fuel; s.co2 += co2;
  stor(SK.STATS, s);
}

function renderStats() {
  const s = load(SK.STATS, { km:0, trips:0, cost:0, fuel:0, co2:0 });
  const km = (s.km||0);
  document.getElementById('total-km').textContent   = km.toFixed(1) + ' km';
  document.getElementById('total-trips').textContent= s.trips || 0;
  document.getElementById('total-cost').textContent = (s.cost||0).toFixed(2).replace('.',',') + ' ‚Ç¨';
  document.getElementById('total-fuel').textContent = (s.fuel||0).toFixed(1) + ' L';
  document.getElementById('total-co2').textContent  = (s.co2||0).toFixed(1) + ' kg';
  const GOAL = 10000;
  const pct  = Math.min((km / GOAL) * 100, 100);
  document.getElementById('km-progress').style.width = pct + '%';
  document.getElementById('progress-goal-lbl').textContent = `${pct.toFixed(1)} % de l'objectif ${GOAL.toLocaleString('fr-FR')} km`;
}

function resetStats() {
  if (!confirm('R√©initialiser toutes les statistiques ?')) return;
  haptic('heavy');
  stor(SK.STATS, { km:0, trips:0, cost:0, fuel:0, co2:0 });
  renderStats();
  toast('Statistiques r√©initialis√©es');
}

/* ================================================================
   SAVE / LOAD TRIP
================================================================ */
function saveTrip() {
  haptic('medium');
  const inputs = document.querySelectorAll('#wp-container input[type="text"]');
  const data = {
    version: '6.0',
    timestamp: new Date().toISOString(),
    waypoints: Array.from(inputs).map(i => i.value),
    vehicle: {
      type:     document.getElementById('vehicleType').value,
      fuelType: document.getElementById('fuelType').value,
      conso:    document.getElementById('conso').value,
      price:    document.getElementById('fuelPrice').value,
      style:    document.getElementById('drivingStyle').value
    },
    route: {
      distance: document.getElementById('h-distance').value,
      duration: document.getElementById('h-duration').value
    }
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `eco-drive-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  toast('Trajet sauvegard√©');
  haptic('success');
}

function loadTrip(input) {
  if (!input.files[0]) return;
  haptic('light');
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const d = JSON.parse(e.target.result);
      document.getElementById('wp-container').innerHTML = `
        <div class="field filled" id="wp-start">
          <input type="text" id="startAddr" placeholder=" " oninput="onAddrInput(this)">
          <label>D√©part</label>
          <button class="icon-btn" onclick="locateMe('startAddr',this)" aria-label="Position">
            <span class="material-symbols-rounded">near_me</span>
          </button>
        </div>
        <div class="field filled" id="wp-end">
          <input type="text" id="endAddr" placeholder=" " oninput="onAddrInput(this)">
          <label>Destination</label>
          <button class="icon-btn" aria-label="Destination">
            <span class="material-symbols-rounded">flag</span>
          </button>
        </div>`;
      _wpCount = 0;
      if (d.waypoints?.length > 0) {
        document.getElementById('startAddr').value = d.waypoints[0];
        if (d.waypoints.length > 1)
          document.getElementById('endAddr').value = d.waypoints[d.waypoints.length-1];
        for (let i=1;i<d.waypoints.length-1;i++) {
          addWaypoint();
          const wps = document.querySelectorAll('#wp-container input[type="text"]');
          const t = wps[wps.length-2];
          if (t) { t.value = d.waypoints[i]; t.parentElement.classList.add('filled'); }
        }
      }
      if (d.vehicle) {
        const vc = document.querySelector(`[data-vt="${d.vehicle.type}"]`);
        if (vc) { document.querySelectorAll('.v-card').forEach(c=>c.classList.remove('selected')); vc.classList.add('selected'); document.getElementById('vehicleType').value = d.vehicle.type; }
        document.getElementById('fuelType').value     = d.vehicle.fuelType||'essence';
        document.getElementById('drivingStyle').value = d.vehicle.style||'1.0';
        setTimeout(()=>{
          if(d.vehicle.conso)  { document.getElementById('conso').value     = d.vehicle.conso; document.getElementById('field-conso').classList.add('filled'); }
          if(d.vehicle.price)  { document.getElementById('fuelPrice').value = d.vehicle.price; document.getElementById('field-price').classList.add('filled'); }
          planTrip(); toast('Trajet charg√©'); haptic('success');
        },120);
      }
    } catch(err) {
      toast('Fichier invalide', true); haptic('error');
    }
  };
  reader.readAsText(input.files[0]);
}

/* ================================================================
   SHARE
================================================================ */
async function shareTrip() {
  haptic('medium');

  // Collect waypoints
  const inputs  = Array.from(document.querySelectorAll('#wp-container input[type="text"]'));
  const addrs   = inputs.map(i => i.value.trim()).filter(Boolean);
  const depart  = addrs[0]   || '‚Äî';
  const arrivee = addrs[addrs.length - 1] || '‚Äî';
  const etapes  = addrs.slice(1, -1);

  // Build itinerary line
  let itinerary = `üö¶ D√©part   : ${depart}\n`;
  etapes.forEach((e, i) => { itinerary += `üìå √âtape ${i+1} : ${e}\n`; });
  itinerary += `üèÅ Arriv√©e  : ${arrivee}`;

  const text =
`üöó Eco-Drive ‚Äî Mon trajet

${itinerary}

üìè Distance : ${document.getElementById('dist-val').textContent}
‚è±Ô∏è Dur√©e    : ${document.getElementById('time-val').textContent}
‚õΩ Carburant : ${document.getElementById('fuel-amount').textContent}
üí∂ Co√ªt estim√© : ${document.getElementById('total-val').textContent}
üåø CO‚ÇÇ      : ${document.getElementById('co2-amount').textContent}

üîó https://sanobld.github.io/Eco-Drive/`;

  if (navigator.share) {
    try {
      await navigator.share({ title: 'Eco-Drive ‚Äî Mon trajet', text });
      toast('Partag√© avec succ√®s'); haptic('success'); updateStats();
      return;
    } catch(e) { if (e.name === 'AbortError') return; }
  }
  navigator.clipboard?.writeText(text)
    .then(() => { toast('Copi√© dans le presse-papier'); haptic('success'); updateStats(); })
    .catch(() => toast('Impossible de copier', true));
}

/* ================================================================
   SETTINGS
================================================================ */
function openSettings() {
  haptic('light');
  document.getElementById('settings-dialog').showModal();
}

function saveSettings() {
  stor(SK.SETTINGS, {
    sat:       document.getElementById('sat-toggle').checked,
    mapClick:  document.getElementById('map-click-settings').checked,
    autoZoom:  document.getElementById('auto-zoom').checked,
    carAnim:   document.getElementById('car-anim').checked,
    routeAnim: document.getElementById('route-anim').checked,
    haptic:    document.getElementById('haptic-toggle').checked,
    autoPrice: document.getElementById('auto-price').checked,
    showCO2:   document.getElementById('show-co2').checked,
    history:   document.getElementById('history-toggle').checked,
    geo:       document.getElementById('geo-toggle').checked
  });
}
function restoreSettings() {
  const s = load(SK.SETTINGS, {});
  const set = (id, val) => { if (val !== undefined) document.getElementById(id).checked = val; };
  set('sat-toggle',           s.sat);
  set('auto-zoom',            s.autoZoom);
  set('car-anim',             s.carAnim);
  set('route-anim',           s.routeAnim);
  set('haptic-toggle',        s.haptic);
  set('auto-price',           s.autoPrice);
  set('show-co2',             s.showCO2);
  set('history-toggle',       s.history);
  set('geo-toggle',           s.geo);
  if (s.mapClick) {
    _mapClickOn = true;
    syncMapClickUI();
  }
}

// Persist settings on change
document.querySelectorAll('#settings-dialog input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', saveSettings);
});

/* ================================================================
   TABS
================================================================ */
function switchTab(id) {
  haptic('light');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const idx = { route:0, vehicle:1, result:2, favorites:3, stats:4 }[id];
  if (idx !== undefined) document.querySelectorAll('.nav-item')[idx].classList.add('active');

  if (window.innerWidth < 780) {
    document.getElementById('bottom-sheet').style.height = '62vh';
  }
  if (id === 'favorites') renderFavorites();
  if (id === 'stats')     renderStats();
}

/* ================================================================
   BOTTOM SHEET DRAG
================================================================ */
(function() {
  const sheet = document.getElementById('bottom-sheet');
  const handle= document.getElementById('drag-handle');
  let sy, sh, dragging = false;

  handle.addEventListener('touchstart', e => {
    if (window.innerWidth >= 780) return;
    sy = e.touches[0].clientY; sh = sheet.offsetHeight;
    sheet.style.transition = 'none'; dragging = true; haptic('light');
  }, { passive:true });

  handle.addEventListener('touchmove', e => {
    if (!dragging || window.innerWidth >= 780) return;
    const d = sy - e.touches[0].clientY;
    const h = sh + d;
    if (h > 80 && h < window.innerHeight * 0.92) sheet.style.height = h + 'px';
  }, { passive:true });

  handle.addEventListener('touchend', () => {
    if (!dragging || window.innerWidth >= 780) return;
    dragging = false;
    sheet.style.transition = 'height var(--dur-l) var(--ease-exp)';
    const h = sheet.offsetHeight, vh = window.innerHeight;
    if (h > vh * 0.72)      sheet.style.height = '88vh';
    else if (h < vh * 0.28) sheet.style.height = '44vh';
    else                     sheet.style.height = '62vh';
    haptic('medium');
  });
})();

/* ================================================================
   VEHICLE PRESET SAVE
================================================================ */
function saveVehicle() {
  stor(SK.VEHICLE, {
    type:  document.getElementById('vehicleType').value,
    fuelType: document.getElementById('fuelType').value,
    conso: document.getElementById('conso').value,
    style: document.getElementById('drivingStyle').value
  });
}

/* ================================================================
   INIT
================================================================ */
window.addEventListener('load', () => {
  // 1. Dark mode
  _autoDark  = load(SK.AUTO_DARK, true);
  _manualDark= load(SK.DARK, null);
  document.getElementById('auto-dark-toggle').checked = _autoDark;
  document.getElementById('dark-mode-sub').textContent = _autoDark ? 'Suit le syst√®me' : 'Manuel';
  applyDark(resolveDark());

  // 2. Color theme
  const ct = load(SK.COLOR, 'green');
  if (ct !== 'green') setColorTheme(ct);
  else {
    document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
    document.querySelector('[data-t="green"]').classList.add('active');
  }

  // 3. Tiles (after dark mode set)
  refreshTiles();

  // 4. Settings
  restoreSettings();

  // 5. Vehicle
  const sv = load(SK.VEHICLE, null);
  if (sv) {
    const vc = document.querySelector(`[data-vt="${sv.type}"]`);
    if (vc) { document.querySelectorAll('.v-card').forEach(c=>c.classList.remove('selected')); vc.classList.add('selected'); document.getElementById('vehicleType').value = sv.type; }
    document.getElementById('fuelType').value    = sv.fuelType || 'essence';
    document.getElementById('conso').value       = sv.conso    || '6.5';
    document.getElementById('drivingStyle').value= sv.style    || '1.0';
    document.getElementById('field-conso').classList.add('filled');
  }

  // 6. Fuel price
  setTimeout(() => {
    if (document.getElementById('auto-price').checked) {
      fetchFuelPrice(document.getElementById('refresh-icon'));
    } else {
      calculate();
    }
  }, 1200);

  // 7. Stats
  renderStats();

  toast('Eco-Drive pr√™t');
});
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('Service Worker enregistr√©'))
        .catch((err) => console.log('Erreur SW:', err));
    });
  }
</script>
</body>
</body>
</html>
