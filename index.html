<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Calculateur d'éco-conduite intelligent avec données en temps réel.">
    <meta name="theme-color" content="#fbfdf8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Eco-Drive</title>
    
    <!-- Leaflet & Fonts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0&display=swap" />
    
    <style>
        /* ==========================================
           COLOR THEMES - Multiple themes support
        ========================================== */
        
        :root {
            /* Default: Eco Green Theme */
            --md-sys-color-primary: #006c45;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #8ef7c0;
            --md-sys-color-on-primary-container: #002112;
            
            --md-sys-color-secondary: #4d6356;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #d0e8d7;
            --md-sys-color-on-secondary-container: #0a1f15;
            
            --md-sys-color-tertiary: #3c6472;
            --md-sys-color-tertiary-container: #c0e9fa;
            --md-sys-color-on-tertiary-container: #001f29;

            --md-sys-color-surface: #fbfdf8;
            --md-sys-color-on-surface: #191c1a;
            --md-sys-color-surface-container: #eceee9;
            --md-sys-color-surface-container-high: #e6e9e4;
            --md-sys-color-surface-container-highest: #e1e3df;
            
            --md-sys-color-outline: #717973;
            --md-sys-color-outline-variant: #c0c9c2;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-error-container: #ffdad6;
            
            /* Elevation & Shape */
            --elevation-0: none;
            --elevation-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --elevation-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --elevation-3: 0 10px 20px rgba(0,0,0,0.10), 0 6px 6px rgba(0,0,0,0.10);
            --elevation-4: 0 14px 28px rgba(0,0,0,0.15), 0 10px 10px rgba(0,0,0,0.12);
            --shape-corner-large: 28px;
            --shape-corner-medium: 16px;
            --shape-corner-small: 8px;
            --shape-corner-extra-small: 4px;

            /* Animation */
            --motion-easing-standard: cubic-bezier(0.2, 0.0, 0, 1.0);
            --motion-easing-emphasized: cubic-bezier(0.05, 0.7, 0.1, 1.0);
            --motion-duration-short: 150ms;
            --motion-duration-medium: 250ms;
            --motion-duration-long: 400ms;
        }

        /* Ocean Blue Theme */
        body.theme-ocean {
            --md-sys-color-primary: #006494;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #c8e6ff;
            --md-sys-color-on-primary-container: #001e2f;
            --md-sys-color-secondary: #4f606e;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #d2e4f5;
            --md-sys-color-on-secondary-container: #0b1d29;
        }

        /* Purple Night Theme */
        body.theme-purple {
            --md-sys-color-primary: #7e3ff2;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #ead6ff;
            --md-sys-color-on-primary-container: #27005d;
            --md-sys-color-secondary: #625b71;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #e8def8;
            --md-sys-color-on-secondary-container: #1e192b;
        }

        /* Sunset Orange Theme */
        body.theme-sunset {
            --md-sys-color-primary: #c44900;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #ffdbc9;
            --md-sys-color-on-primary-container: #2d1600;
            --md-sys-color-secondary: #765848;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #ffdbc9;
            --md-sys-color-on-secondary-container: #2b160a;
        }

        /* Rose Theme */
        body.theme-rose {
            --md-sys-color-primary: #b91c5f;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #ffd9e2;
            --md-sys-color-on-primary-container: #3e001d;
            --md-sys-color-secondary: #74565f;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #ffd9e2;
            --md-sys-color-on-secondary-container: #2b151c;
        }

        /* Dark Theme Overrides */
        @media (prefers-color-scheme: dark) {
            :root {
                --md-sys-color-primary: #71da9f;
                --md-sys-color-on-primary: #003822;
                --md-sys-color-primary-container: #005233;
                --md-sys-color-on-primary-container: #8ef7c0;
                --md-sys-color-surface: #101412;
                --md-sys-color-on-surface: #e1e3df;
                --md-sys-color-surface-container: #1d201e;
                --md-sys-color-surface-container-high: #272b28;
                --md-sys-color-surface-container-highest: #323633;
                --md-sys-color-outline: #8b938c;
                --md-sys-color-outline-variant: #414943;
            }
        }

        body.dark-theme {
            --md-sys-color-primary: #71da9f;
            --md-sys-color-on-primary: #003822;
            --md-sys-color-primary-container: #005233;
            --md-sys-color-on-primary-container: #8ef7c0;
            --md-sys-color-surface: #101412;
            --md-sys-color-on-surface: #e1e3df;
            --md-sys-color-surface-container: #1d201e;
            --md-sys-color-surface-container-high: #272b28;
            --md-sys-color-surface-container-highest: #323633;
            --md-sys-color-outline: #8b938c;
            --md-sys-color-outline-variant: #414943;
        }

        body.dark-theme.theme-ocean {
            --md-sys-color-primary: #8fd0ff;
            --md-sys-color-on-primary: #00344f;
        }

        body.dark-theme.theme-purple {
            --md-sys-color-primary: #d6baff;
            --md-sys-color-on-primary: #42009d;
        }

        body.dark-theme.theme-sunset {
            --md-sys-color-primary: #ffb68e;
            --md-sys-color-on-primary: #512300;
        }

        body.dark-theme.theme-rose {
            --md-sys-color-primary: #ffb1c8;
            --md-sys-color-on-primary: #650033;
        }

        /* ==========================================
           GLOBAL STYLES
        ========================================== */
        
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Roboto', sans-serif; 
            margin: 0; 
            height: 100vh; 
            width: 100vw;
            background: var(--md-sys-color-surface); 
            color: var(--md-sys-color-on-surface);
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            transition: background var(--motion-duration-medium) var(--motion-easing-standard), 
                        color var(--motion-duration-medium) var(--motion-easing-standard);
        }
        
        h1, h2, h3 { 
            font-family: 'Google Sans', sans-serif; 
            margin: 0; 
        }
        
        button { 
            font-family: 'Google Sans', sans-serif;
            touch-action: manipulation;
        }

        /* Map Container */
        #map-container {
            flex: 1; 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 1;
        }
        
        #map { 
            width: 100%; 
            height: 100%; 
            background: var(--md-sys-color-surface-container);
            cursor: crosshair;
        }
        
        #map.click-disabled {
            cursor: grab;
        }

        #map.click-disabled:active {
            cursor: grabbing;
        }
        
        .leaflet-routing-container { display: none !important; }
        .leaflet-control-zoom { display: none !important; }

        /* Custom Route Line with Animation */
        .animated-route-line {
            stroke-dasharray: 10 5;
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .gradient-route-line {
            stroke: url(#routeGradient);
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            z-index: 2; 
            pointer-events: none;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
        }

        /* Top Bar */
        .top-bar {
            pointer-events: auto;
            padding: max(env(safe-area-inset-top), 16px) 20px 16px 20px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            animation: slideDown var(--motion-duration-long) var(--motion-easing-emphasized);
        }

        @keyframes slideDown {
            from { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .app-title {
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
            padding: 10px 18px; 
            border-radius: 50px;
            font-size: 0.9rem; 
            font-weight: 500;
            box-shadow: var(--elevation-2);
            display: flex; 
            align-items: center; 
            gap: 8px;
            backdrop-filter: blur(10px);
            transition: all var(--motion-duration-medium) var(--motion-easing-standard);
        }

        .app-title:active {
            transform: scale(0.98);
        }

        /* FAB Stack */
        .fab-stack {
            position: absolute; 
            right: 16px; 
            bottom: calc(45vh + 20px);
            display: flex; 
            flex-direction: column; 
            gap: 12px;
            pointer-events: auto;
            transition: bottom var(--motion-duration-long) var(--motion-easing-emphasized);
            animation: slideLeft var(--motion-duration-long) var(--motion-easing-emphasized) 200ms backwards;
        }

        @keyframes slideLeft {
            from { 
                opacity: 0; 
                transform: translateX(80px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        .fab {
            width: 56px; 
            height: 56px; 
            border-radius: 16px;
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border: none; 
            box-shadow: var(--elevation-3);
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            transition: all var(--motion-duration-medium) var(--motion-easing-standard);
            position: relative;
            overflow: hidden;
        }

        .fab::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width var(--motion-duration-medium), height var(--motion-duration-medium);
        }

        .fab:active::before {
            width: 100px;
            height: 100px;
        }
        
        .fab.small { 
            width: 48px; 
            height: 48px; 
            border-radius: 12px; 
            background: var(--md-sys-color-surface-container-high); 
            color: var(--md-sys-color-on-surface); 
        }
        
        .fab:active { 
            transform: scale(0.92); 
        }

        .fab:hover {
            box-shadow: var(--elevation-4);
        }

        /* Bottom Sheet */
        #bottom-sheet {
            pointer-events: auto;
            background: var(--md-sys-color-surface);
            width: 100%;
            height: 45vh;
            max-height: 90vh;
            border-radius: var(--shape-corner-large) var(--shape-corner-large) 0 0;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.15);
            display: flex; 
            flex-direction: column;
            transition: height var(--motion-duration-long) var(--motion-easing-emphasized);
            position: absolute; 
            bottom: 0;
            z-index: 10;
            animation: slideUp var(--motion-duration-long) var(--motion-easing-emphasized) 300ms backwards;
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(100%); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @media (min-width: 800px) {
            #bottom-sheet {
                width: 450px; 
                height: auto; 
                max-height: 85vh;
                left: 24px; 
                bottom: 24px; 
                top: 24px;
                border-radius: var(--shape-corner-large);
                box-shadow: var(--elevation-3);
            }
            .fab-stack { 
                right: 24px; 
                bottom: 24px; 
            }
            .nav-bar { 
                border-radius: 0 0 28px 28px; 
            }
        }

        .sheet-handle-area {
            width: 100%; 
            padding: 16px 0 8px 0;
            display: flex; 
            justify-content: center; 
            align-items: center;
            cursor: grab; 
            flex-shrink: 0;
        }
        
        .sheet-handle {
            width: 32px; 
            height: 4px; 
            border-radius: 2px;
            background: var(--md-sys-color-outline-variant);
            transition: all var(--motion-duration-short);
        }

        .sheet-handle-area:active .sheet-handle {
            width: 40px;
            background: var(--md-sys-color-outline);
        }

        /* Sheet Content */
        .sheet-content {
            flex: 1; 
            overflow-y: auto; 
            padding: 0 24px 80px 24px;
            scrollbar-width: thin;
            scrollbar-color: var(--md-sys-color-outline-variant) transparent;
        }
        
        .sheet-content::-webkit-scrollbar { 
            width: 6px; 
        }
        
        .sheet-content::-webkit-scrollbar-track { 
            background: transparent; 
        }
        
        .sheet-content::-webkit-scrollbar-thumb { 
            background: var(--md-sys-color-outline-variant); 
            border-radius: 3px; 
        }

        /* Navigation Bar */
        .nav-bar {
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0;
            height: 80px; 
            background: var(--md-sys-color-surface-container);
            display: flex; 
            justify-content: space-around; 
            align-items: center;
            border-top: 1px solid var(--md-sys-color-outline-variant);
            z-index: 20;
            padding-bottom: max(env(safe-area-inset-bottom), 0px);
        }
        
        .nav-item {
            background: none; 
            border: none; 
            flex: 1;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px;
            color: var(--md-sys-color-outline);
            font-size: 0.7rem; 
            font-weight: 500; 
            cursor: pointer;
            padding: 10px 0;
            transition: color var(--motion-duration-medium) var(--motion-easing-standard);
            position: relative;
        }
        
        .nav-item span { 
            font-size: 24px; 
            transition: all var(--motion-duration-medium) var(--motion-easing-emphasized);
        }
        
        .nav-item.active { 
            color: var(--md-sys-color-on-surface); 
        }
        
        .nav-item.active .material-symbols-rounded {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            width: 64px; 
            height: 32px; 
            border-radius: 16px;
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        /* Tab Sections */
        .tab-section { 
            display: none; 
        }
        
        .tab-section.active { 
            display: block; 
            animation: fadeInUp var(--motion-duration-long) var(--motion-easing-emphasized);
        }
        
        @keyframes fadeInUp { 
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }

        /* Input Groups */
        .md-input-group {
            position: relative; 
            margin-bottom: 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--shape-corner-small);
            padding: 0 12px;
            display: flex; 
            align-items: center;
            min-height: 56px;
            transition: all var(--motion-duration-medium) var(--motion-easing-standard);
            background: var(--md-sys-color-surface);
        }
        
        .md-input-group:focus-within { 
            border-color: var(--md-sys-color-primary); 
            border-width: 2px;
            padding: 0 11px;
            box-shadow: 0 0 0 4px rgba(0, 108, 69, 0.1);
        }
        
        .md-input {
            border: none; 
            background: transparent; 
            width: 100%; 
            height: 100%;
            font-size: 1rem; 
            color: var(--md-sys-color-on-surface); 
            outline: none;
            padding-top: 16px;
            font-family: 'Roboto', sans-serif;
        }
        
        .md-label {
            position: absolute; 
            left: 12px; 
            top: 18px;
            color: var(--md-sys-color-outline); 
            font-size: 1rem;
            pointer-events: none; 
            transition: all var(--motion-duration-medium) var(--motion-easing-standard);
            background: var(--md-sys-color-surface); 
            padding: 0 4px;
        }
        
        .md-input:focus ~ .md-label, 
        .md-input:not(:placeholder-shown) ~ .md-label,
        .md-input-group.has-value .md-label {
            top: -10px; 
            font-size: 0.75rem; 
            color: var(--md-sys-color-primary);
        }
        
        .icon-btn {
            background: none; 
            border: none; 
            cursor: pointer;
            color: var(--md-sys-color-outline);
            padding: 8px; 
            margin-right: -8px;
            border-radius: 50%;
            transition: all var(--motion-duration-short);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:active {
            background: var(--md-sys-color-surface-container);
            transform: scale(0.9);
        }

        /* Toolbar Chips */
        .toolbar {
            display: flex; 
            gap: 8px; 
            overflow-x: auto; 
            padding-bottom: 16px;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        .toolbar::-webkit-scrollbar {
            display: none;
        }
        
        .chip {
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--shape-corner-small); 
            padding: 8px 14px;
            background: transparent; 
            color: var(--md-sys-color-on-surface);
            font-size: 0.875rem; 
            font-weight: 500;
            display: flex; 
            align-items: center; 
            gap: 6px; 
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--motion-duration-medium) var(--motion-easing-standard);
            position: relative;
            overflow: hidden;
        }
        
        .chip:hover { 
            background: var(--md-sys-color-surface-container-high); 
        }

        .chip:active {
            transform: scale(0.95);
            background: var(--md-sys-color-surface-container);
        }

        /* Vehicle Grid */
        .vehicle-grid {
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            margin-bottom: 24px;
        }
        
        .vehicle-option {
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 12px; 
            padding: 16px 12px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px;
            cursor: pointer; 
            transition: all var(--motion-duration-medium) var(--motion-easing-emphasized);
            text-align: center;
            position: relative;
        }

        .vehicle-option::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            background: var(--md-sys-color-secondary-container);
            opacity: 0;
            transition: opacity var(--motion-duration-medium);
        }
        
        .vehicle-option.selected::before {
            opacity: 1;
        }

        .vehicle-option.selected {
            border-color: transparent;
            color: var(--md-sys-color-on-secondary-container);
            transform: scale(1.05);
            box-shadow: var(--elevation-2);
        }
        
        .vehicle-option span { 
            font-size: 28px;
            position: relative;
            z-index: 1;
        }
        
        .vehicle-option p { 
            margin: 0; 
            font-size: 0.75rem; 
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .vehicle-option:active {
            transform: scale(0.95);
        }

        /* Result Card */
        .result-card {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-radius: 24px; 
            padding: 32px 24px;
            text-align: center; 
            margin: 20px 0;
            box-shadow: var(--elevation-1);
            transition: all var(--motion-duration-medium);
            animation: scaleIn var(--motion-duration-long) var(--motion-easing-emphasized);
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .price-big { 
            font-size: 3.5rem; 
            line-height: 1; 
            font-weight: 700; 
            font-family: 'Google Sans'; 
            display: block;
        }
        
        .price-label { 
            font-size: 0.9rem; 
            opacity: 0.8; 
            font-weight: 500; 
        }

        /* Action Button */
        .btn-filled {
            width: 100%; 
            background: var(--md-sys-color-primary); 
            color: var(--md-sys-color-on-primary);
            padding: 16px; 
            border-radius: 100px; 
            border: none;
            font-size: 1rem; 
            font-weight: 500; 
            cursor: pointer;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 8px;
            box-shadow: var(--elevation-2); 
            transition: all var(--motion-duration-medium) var(--motion-easing-standard);
            position: relative;
            overflow: hidden;
        }

        .btn-filled::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width var(--motion-duration-long), height var(--motion-duration-long);
        }

        .btn-filled:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-filled:hover { 
            box-shadow: var(--elevation-3);
            transform: translateY(-2px);
        }

        .btn-filled:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-filled:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Settings Dialog */
        dialog {
            border: none; 
            border-radius: 28px;
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
            padding: 24px; 
            width: 90%; 
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--elevation-4);
            animation: dialogIn var(--motion-duration-long) var(--motion-easing-emphasized);
        }

        @keyframes dialogIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        dialog::backdrop { 
            background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(4px);
            animation: fadeIn var(--motion-duration-medium);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .dialog-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
        }
        
        .dialog-header h3 { 
            font-size: 1.25rem; 
        }

        .dialog-section {
            margin-bottom: 24px;
        }

        .dialog-section h4 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--md-sys-color-outline);
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .setting-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px;
            padding: 8px 0;
        }
        
        .setting-label { 
            font-size: 0.95rem; 
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .setting-sublabel {
            font-size: 0.75rem;
            color: var(--md-sys-color-outline);
        }

        /* Toggle Switch */
        .switch { 
            position: relative; 
            display: inline-block; 
            width: 52px; 
            height: 32px; 
        }
        
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        .slider {
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background-color: var(--md-sys-color-surface-container-highest); 
            border-radius: 34px; 
            transition: var(--motion-duration-medium);
            border: 2px solid var(--md-sys-color-outline);
        }
        
        .slider:before {
            position: absolute; 
            content: ""; 
            height: 16px; 
            width: 16px; 
            left: 6px; 
            bottom: 6px;
            background-color: var(--md-sys-color-outline); 
            border-radius: 50%; 
            transition: var(--motion-duration-medium) var(--motion-easing-emphasized);
        }
        
        input:checked + .slider { 
            background-color: var(--md-sys-color-primary); 
            border-color: var(--md-sys-color-primary); 
        }
        
        input:checked + .slider:before { 
            transform: translateX(20px); 
            background-color: var(--md-sys-color-on-primary); 
        }

        /* Color Theme Picker */
        .theme-picker {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .theme-option {
            aspect-ratio: 1;
            border-radius: 12px;
            border: 2px solid var(--md-sys-color-outline-variant);
            cursor: pointer;
            transition: all var(--motion-duration-medium);
            position: relative;
            overflow: hidden;
        }

        .theme-option::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%);
        }

        .theme-option.selected {
            border-color: var(--md-sys-color-primary);
            border-width: 3px;
            transform: scale(1.05);
            box-shadow: var(--elevation-2);
        }

        .theme-option.selected::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .theme-option[data-theme="green"] { --theme-primary: #006c45; --theme-secondary: #8ef7c0; }
        .theme-option[data-theme="ocean"] { --theme-primary: #006494; --theme-secondary: #c8e6ff; }
        .theme-option[data-theme="purple"] { --theme-primary: #7e3ff2; --theme-secondary: #ead6ff; }
        .theme-option[data-theme="sunset"] { --theme-primary: #c44900; --theme-secondary: #ffdbc9; }
        .theme-option[data-theme="rose"] { --theme-primary: #b91c5f; --theme-secondary: #ffd9e2; }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: var(--elevation-3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 90%;
            opacity: 0;
            transition: all var(--motion-duration-medium) var(--motion-easing-emphasized);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.error {
            background: var(--md-sys-color-error-container);
            color: var(--md-sys-color-error);
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-top-color: var(--md-sys-color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }

        .stat-card {
            background: var(--md-sys-color-surface-container);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            transition: all var(--motion-duration-medium);
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--md-sys-color-primary);
            display: block;
            font-family: 'Google Sans';
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--md-sys-color-outline);
            margin-top: 4px;
        }

        /* Eco Tips Card */
        .eco-tip {
            margin-top: 24px; 
            padding: 20px; 
            background: var(--md-sys-color-tertiary-container); 
            color: var(--md-sys-color-on-tertiary-container);
            border-radius: 16px;
            animation: slideInRight var(--motion-duration-long) var(--motion-easing-emphasized) 400ms backwards;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .eco-tip h4 {
            margin: 0 0 8px 0; 
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .eco-tip p {
            margin: 0; 
            font-size: 0.85rem; 
            opacity: 0.9; 
            line-height: 1.5;
        }

        /* Favorites List */
        .favorite-item {
            background: var(--md-sys-color-surface-container);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all var(--motion-duration-medium);
        }

        .favorite-item:hover {
            background: var(--md-sys-color-surface-container-high);
        }

        .favorite-item:active {
            transform: scale(0.98);
        }

        .favorite-info {
            flex: 1;
        }

        .favorite-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .favorite-details {
            font-size: 0.8rem;
            color: var(--md-sys-color-outline);
        }

        .favorite-actions {
            display: flex;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--md-sys-color-outline);
        }

        .empty-state span {
            font-size: 64px;
            opacity: 0.5;
            display: block;
            margin-bottom: 16px;
        }

        /* Big Stats Cards */
        .big-stat-card {
            background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-secondary-container));
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            color: var(--md-sys-color-on-primary-container);
        }

        .big-stat-value {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'Google Sans';
            line-height: 1;
            margin-bottom: 8px;
        }

        .big-stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        #fileInput { display: none; }

        /* Car animation improvements */
        .car-marker {
            position: relative;
            width: 50px;
            height: 50px;
        }

        .car-shadow {
            position: absolute;
            width: 40px;
            height: 10px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.3) 0%, transparent 70%);
            bottom: -5px;
            left: 5px;
            border-radius: 50%;
            animation: shadowPulse 1s infinite;
        }

        @keyframes shadowPulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.5; }
        }

        .car-trail {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.3;
            animation: trailFade 0.5s ease-out;
        }

        @keyframes trailFade {
            from { opacity: 0.6; transform: scale(1.2); }
            to { opacity: 0; transform: scale(0.8); }
        }

        /* Click indicator on map */
        .click-indicator {
            width: 20px;
            height: 20px;
            background: var(--md-sys-color-primary);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            animation: clickPulse 0.6s ease-out;
        }

        @keyframes clickPulse {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Pulse Animation for Map Markers */
        .pulse-icon {
            border-radius: 50%;
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0% { 
                transform: scale(0.95); 
                box-shadow: 0 0 0 0 rgba(0, 109, 59, 0.7); 
            }
            70% { 
                transform: scale(1); 
                box-shadow: 0 0 0 10px rgba(0, 109, 59, 0); 
            }
            100% { 
                transform: scale(0.95); 
                box-shadow: 0 0 0 0 rgba(0, 109, 59, 0); 
            }
        }

        /* Progress bar for stats */
        .progress-bar {
            height: 8px;
            background: var(--md-sys-color-surface-container-high);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--md-sys-color-primary);
            border-radius: 4px;
            transition: width 0.6s var(--motion-easing-emphasized);
        }
    </style>
</head>
<body>

    <!-- SVG Definitions for Route Gradient -->
    <svg style="position: absolute; width: 0; height: 0;">
        <defs>
            <linearGradient id="routeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:var(--md-sys-color-primary);stop-opacity:1" />
                <stop offset="100%" style="stop-color:var(--md-sys-color-tertiary);stop-opacity:1" />
            </linearGradient>
        </defs>
    </svg>

    <!-- Map Layer -->
    <div id="map-container">
        <div id="map"></div>
    </div>

    <!-- UI Overlay -->
    <div id="ui-layer">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="app-title">
                <span class="material-symbols-rounded" style="color:var(--md-sys-color-primary)">eco</span>
                Eco-Drive
            </div>
            <button class="fab small" onclick="document.getElementById('settings-dialog').showModal()" aria-label="Paramètres">
                <span class="material-symbols-rounded">settings</span>
            </button>
        </div>

        <!-- FABs -->
        <div class="fab-stack">
            <button class="fab" onclick="fitRoute()" aria-label="Recentrer la carte">
                <span class="material-symbols-rounded">crop_free</span>
            </button>
            <button class="fab" style="background:var(--md-sys-color-tertiary-container); color:var(--md-sys-color-on-tertiary-container)" onclick="locateMe('startAddr')" aria-label="Me localiser">
                <span class="material-symbols-rounded">my_location</span>
            </button>
        </div>
    </div>

    <!-- Bottom Sheet -->
    <div id="bottom-sheet">
        <div class="sheet-handle-area" id="sheet-drag">
            <div class="sheet-handle"></div>
        </div>

        <div class="sheet-content">
            
            <!-- Tab 1: Trajet -->
            <div id="tab-route" class="tab-section active">
                <div class="toolbar">
                    <button class="chip" onclick="saveTrip()">
                        <span class="material-symbols-rounded" style="font-size:18px">save</span> 
                        Sauvegarder
                    </button>
                    <button class="chip" onclick="document.getElementById('fileInput').click()">
                        <span class="material-symbols-rounded" style="font-size:18px">upload</span> 
                        Charger
                    </button>
                    <button class="chip" onclick="addWaypoint()">
                        <span class="material-symbols-rounded" style="font-size:18px">add_location</span> 
                        Étape
                    </button>
                    <button class="chip" onclick="toggleMapClick()">
                        <span class="material-symbols-rounded" style="font-size:18px" id="map-click-icon">touch_app</span> 
                        Clic carte
                    </button>
                </div>

                <div id="waypoints-container" style="margin-top: 16px;">
                    <div class="md-input-group" id="wp-group-0">
                        <input type="text" class="md-input" id="startAddr" placeholder=" " onchange="planTrip()">
                        <label class="md-label">Départ</label>
                        <button class="icon-btn" onclick="locateMe('startAddr')" aria-label="Utiliser ma position">
                            <span class="material-symbols-rounded">near_me</span>
                        </button>
                    </div>
                    
                    <div class="md-input-group" id="wp-group-end">
                        <input type="text" class="md-input" id="endAddr" placeholder=" " onchange="planTrip()">
                        <label class="md-label">Destination</label>
                        <button class="icon-btn" aria-label="Destination">
                            <span class="material-symbols-rounded">flag</span>
                        </button>
                    </div>
                </div>
                
                <div style="text-align:center; margin-top:16px; font-size:0.85rem; color:var(--md-sys-color-outline);">
                    Distance: <strong id="dist-display">0 km</strong> · Durée: <strong id="time-display">0 min</strong>
                </div>
            </div>

            <!-- Tab 2: Véhicule -->
            <div id="tab-vehicle" class="tab-section">
                <h3 style="font-size:1.1rem; margin-bottom:16px; font-weight: 500;">Mon Véhicule</h3>
                
                <div class="vehicle-grid">
                    <div class="vehicle-option selected" onclick="selectVehicle('sedan', this)" data-val="sedan">
                        <span class="material-symbols-rounded">directions_car</span>
                        <p>Berline</p>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('suv', this)" data-val="suv">
                        <span class="material-symbols-rounded">airport_shuttle</span>
                        <p>SUV</p>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('city', this)" data-val="city">
                        <span class="material-symbols-rounded">electric_car</span>
                        <p>Citadine</p>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('moto', this)" data-val="moto">
                        <span class="material-symbols-rounded">two_wheeler</span>
                        <p>Moto</p>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('van', this)" data-val="van">
                        <span class="material-symbols-rounded">local_shipping</span>
                        <p>Utilitaire</p>
                    </div>
                    <div class="vehicle-option" onclick="selectVehicle('custom', this)" data-val="custom">
                        <span class="material-symbols-rounded">tune</span>
                        <p>Perso</p>
                    </div>
                </div>
                
                <select id="vehicleType" style="display:none"><option value="sedan">sedan</option></select>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                    <div class="md-input-group">
                        <select class="md-input" id="fuelType" onchange="applyPreset()" style="padding-top:0">
                            <option value="essence">Essence</option>
                            <option value="diesel">Diesel</option>
                            <option value="elec">Électrique</option>
                            <option value="ethanol">Éthanol</option>
                            <option value="gpl">GPL</option>
                        </select>
                    </div>
                    <div class="md-input-group">
                        <select class="md-input" id="drivingStyle" onchange="calculate()" style="padding-top:0">
                            <option value="1.0">Normale</option>
                            <option value="0.9">Éco</option>
                            <option value="1.15">Sportive</option>
                        </select>
                    </div>
                </div>

                <div class="md-input-group">
                    <input type="number" class="md-input" id="conso" value="6.5" step="0.1" oninput="calculate()" placeholder=" ">
                    <label class="md-label" id="consoLabel">Conso. Moyenne (L/100km)</label>
                </div>

                <div class="md-input-group">
                    <input type="number" class="md-input" id="price" value="1.75" step="0.01" oninput="calculate()" placeholder=" ">
                    <label class="md-label" id="priceLabel">Prix Carburant (€/L)</label>
                    <button class="icon-btn" onclick="fetchFuelPrice()" aria-label="Actualiser le prix">
                        <span class="material-symbols-rounded" id="refresh-icon">refresh</span>
                    </button>
                </div>

                <div id="price-source" style="font-size: 0.75rem; color: var(--md-sys-color-outline); text-align: center; margin-top: 8px; min-height: 16px;"></div>
            </div>

            <!-- Tab 3: Résultats -->
            <div id="tab-result" class="tab-section">
                <div class="result-card">
                    <span class="price-big" id="total-val">0.00 €</span>
                    <span class="price-label" id="pp-val">Coût estimé du trajet</span>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-value" id="fuel-amount">0 L</span>
                        <span class="stat-label">Carburant</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="co2-amount">0 kg</span>
                        <span class="stat-label">CO₂ émis</span>
                    </div>
                </div>
                
                <button class="btn-filled" onclick="addToFavorites()" style="margin-bottom: 12px;">
                    <span class="material-symbols-rounded">favorite</span>
                    Ajouter aux favoris
                </button>

                <button class="btn-filled" onclick="shareTrip()">
                    <span class="material-symbols-rounded">share</span>
                    Partager le récapitulatif
                </button>
                
                <div class="eco-tip">
                    <h4>
                        <span class="material-symbols-rounded" style="font-size: 20px;">lightbulb</span>
                        Astuce Éco
                    </h4>
                    <p id="eco-tip-text">
                        Réduire votre vitesse de 10 km/h sur autoroute peut économiser jusqu'à 15% de carburant.
                    </p>
                </div>
            </div>

            <!-- Tab 4: Favoris -->
            <div id="tab-favorites" class="tab-section">
                <h3 style="font-size:1.1rem; margin-bottom:16px; font-weight: 500;">Trajets Favoris</h3>
                
                <div id="favorites-list">
                    <div class="empty-state">
                        <span class="material-symbols-rounded">bookmark_border</span>
                        <p>Aucun trajet favori<br><small>Ajoutez vos trajets réguliers ici</small></p>
                    </div>
                </div>
            </div>

            <!-- Tab 5: Statistiques -->
            <div id="tab-stats" class="tab-section">
                <h3 style="font-size:1.1rem; margin-bottom:16px; font-weight: 500;">Statistiques Globales</h3>
                
                <div class="big-stat-card">
                    <div class="big-stat-value" id="total-km">0 km</div>
                    <div class="big-stat-label">Distance totale parcourue</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="km-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-value" id="total-trips">0</span>
                        <span class="stat-label">Trajets calculés</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="total-cost">0 €</span>
                        <span class="stat-label">Coût total</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="total-fuel">0 L</span>
                        <span class="stat-label">Carburant total</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="total-co2">0 kg</span>
                        <span class="stat-label">CO₂ total</span>
                    </div>
                </div>

                <button class="btn-filled" onclick="resetStats()" style="margin-top: 20px; background: var(--md-sys-color-error);">
                    <span class="material-symbols-rounded">delete_forever</span>
                    Réinitialiser les stats
                </button>
            </div>

        </div>

        <!-- Navigation Bar -->
        <div class="nav-bar">
            <button class="nav-item active" onclick="switchTab('route')" aria-label="Trajet">
                <span class="material-symbols-rounded">map</span>
                Trajet
            </button>
            <button class="nav-item" onclick="switchTab('vehicle')" aria-label="Véhicule">
                <span class="material-symbols-rounded">directions_car</span>
                Véhicule
            </button>
            <button class="nav-item" onclick="switchTab('result')" aria-label="Coût">
                <span class="material-symbols-rounded">payments</span>
                Coût
            </button>
            <button class="nav-item" onclick="switchTab('favorites')" aria-label="Favoris">
                <span class="material-symbols-rounded">bookmark</span>
                Favoris
            </button>
            <button class="nav-item" onclick="switchTab('stats')" aria-label="Stats">
                <span class="material-symbols-rounded">analytics</span>
                Stats
            </button>
        </div>
    </div>

    <!-- Hidden Fields -->
    <input type="hidden" id="distance" value="0">
    <input type="hidden" id="duration" value="0">
    <input type="file" id="fileInput" accept=".json" onchange="loadTrip(this)">

    <!-- Settings Dialog -->
    <dialog id="settings-dialog">
        <div class="dialog-header">
            <h3>Paramètres</h3>
            <button onclick="document.getElementById('settings-dialog').close()" style="background:none; border:none; color:var(--md-sys-color-on-surface); cursor:pointer; padding: 8px; border-radius: 50%;" aria-label="Fermer">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>

        <!-- Apparence -->
        <div class="dialog-section">
            <h4>Apparence</h4>
            
            <div class="setting-row">
                <span class="setting-label">Mode Sombre</span>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle" onchange="toggleThemeManual()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <span class="setting-label">
                    Thème de couleur
                    <span class="setting-sublabel">Personnalisez votre expérience</span>
                </span>
            </div>
            <div class="theme-picker">
                <div class="theme-option selected" data-theme="green" onclick="changeColorTheme('green')"></div>
                <div class="theme-option" data-theme="ocean" onclick="changeColorTheme('ocean')"></div>
                <div class="theme-option" data-theme="purple" onclick="changeColorTheme('purple')"></div>
                <div class="theme-option" data-theme="sunset" onclick="changeColorTheme('sunset')"></div>
                <div class="theme-option" data-theme="rose" onclick="changeColorTheme('rose')"></div>
            </div>
        </div>

        <!-- Carte -->
        <div class="dialog-section">
            <h4>Carte</h4>
            
            <div class="setting-row">
                <span class="setting-label">
                    Carte Satellite
                    <span class="setting-sublabel">Vue satellite au lieu de la carte</span>
                </span>
                <label class="switch">
                    <input type="checkbox" id="sat-toggle" onchange="toggleSatellite()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <span class="setting-label">
                    Clic sur la carte
                    <span class="setting-sublabel">Ajouter des points en cliquant</span>
                </span>
                <label class="switch">
                    <input type="checkbox" id="map-click-toggle" onchange="toggleMapClick()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <span class="setting-label">
                    Zoom auto
                    <span class="setting-sublabel">Ajuster la vue automatiquement</span>
                </span>
                <label class="switch">
                    <input type="checkbox" checked id="auto-zoom-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Animations -->
        <div class="dialog-section">
            <h4>Animations</h4>
            
            <div class="setting-row">
                <span class="setting-label">
                    Animation de la voiture
                    <span class="setting-sublabel">Voiture animée sur le trajet</span>
                </span>
                <label class="switch">
                    <input type="checkbox" checked id="anim-toggle">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <span class="setting-label">
                    Animation du tracé
                    <span class="setting-sublabel">Ligne d'itinéraire animée</span>
                </span>
                <label class="switch">
                    <input type="checkbox" checked id="route-anim-toggle" onchange="toggleRouteAnimation()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <span class="setting-label">
                    Vibrations (Haptic)
                    <span class="setting-sublabel">Retour haptique sur mobile</span>
                </span>
                <label class="switch">
                    <input type="checkbox" checked id="haptic-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Calculs -->
        <div class="dialog-section">
            <h4>Calculs</h4>
            
            <div class="setting-row">
                <span class="setting-label">
                    Mise à jour auto des prix
                    <span class="setting-sublabel">Actualiser au changement de type</span>
                </span>
                <label class="switch">
                    <input type="checkbox" checked id="auto-price-toggle">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <span class="setting-label">
                    Calculer les péages
                    <span class="setting-sublabel">Estimation des frais d'autoroute</span>
                </span>
                <label class="switch">
                    <input type="checkbox" id="tolls-toggle">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <span class="setting-label">
                    Afficher le CO₂
                    <span class="setting-sublabel">Impact environnemental</span>
                </span>
                <label class="switch">
                    <input type="checkbox" checked id="co2-toggle" onchange="calculate()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Données -->
        <div class="dialog-section">
            <h4>Données & Confidentialité</h4>
            
            <div class="setting-row">
                <span class="setting-label">
                    Sauvegarder l'historique
                    <span class="setting-sublabel">Enregistrer automatiquement</span>
                </span>
                <label class="switch">
                    <input type="checkbox" checked id="history-toggle">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <span class="setting-label">
                    Géolocalisation
                    <span class="setting-sublabel">Autoriser la position GPS</span>
                </span>
                <label class="switch">
                    <input type="checkbox" checked id="geo-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <p style="font-size:0.75rem; color:var(--md-sys-color-outline); margin-top:24px; text-align:center; line-height: 1.6;">
            <strong>Eco-Drive Pro Ultimate v5.0</strong><br>
            Données: OpenStreetMap · Prix carburant en temps réel<br>
            © 2025 - Tous droits réservés
        </p>
    </dialog>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>

    <script>
        // ==========================================
        // STORAGE & PERSISTENCE
        // ==========================================
        
        const STORAGE_KEYS = {
            THEME: 'ecodrive_theme',
            COLOR_THEME: 'ecodrive_color_theme',
            SETTINGS: 'ecodrive_settings',
            FAVORITES: 'ecodrive_favorites',
            STATS: 'ecodrive_stats',
            VEHICLE: 'ecodrive_vehicle'
        };

        function loadFromStorage(key, defaultValue = null) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error('Storage load error:', e);
                return defaultValue;
            }
        }

        function saveToStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.error('Storage save error:', e);
                return false;
            }
        }

        // ==========================================
        // UTILITIES & HELPERS
        // ==========================================

        function haptic(type = 'light') {
            if (!document.getElementById('haptic-toggle').checked) return;
            if (window.navigator.vibrate) {
                const patterns = {
                    light: 10,
                    medium: 20,
                    heavy: 30,
                    success: [10, 50, 10],
                    error: [20, 100, 20]
                };
                window.navigator.vibrate(patterns[type] || 10);
            }
        }

        function showToast(message, isError = false) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.innerHTML = `
                ${isError ? '<span class="material-symbols-rounded">error</span>' : '<span class="material-symbols-rounded">check_circle</span>'}
                ${message}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);

            haptic(isError ? 'error' : 'success');
        }

        // ==========================================
        // THEME MANAGEMENT
        // ==========================================

        function changeColorTheme(theme) {
            haptic('medium');
            
            // Update UI
            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-theme="${theme}"]`).classList.add('selected');
            
            // Remove all theme classes
            document.body.classList.remove('theme-ocean', 'theme-purple', 'theme-sunset', 'theme-rose');
            
            // Add new theme if not default
            if (theme !== 'green') {
                document.body.classList.add(`theme-${theme}`);
            }
            
            // Save to storage
            saveToStorage(STORAGE_KEYS.COLOR_THEME, theme);
            
            // Reinit map theme
            initMapTheme();
            
            showToast(`Thème ${theme} activé`);
        }

        function toggleThemeManual() {
            haptic('medium');
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            saveToStorage(STORAGE_KEYS.THEME, isDark);
            initMapTheme();
            showToast('Thème ' + (isDark ? 'sombre' : 'clair') + ' activé');
        }

        // ==========================================
        // UI INTERACTION LOGIC
        // ==========================================

        function switchTab(tabId) {
            haptic('light');
            
            document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const buttons = document.querySelectorAll('.nav-item');
            const tabMap = { 'route': 0, 'vehicle': 1, 'result': 2, 'favorites': 3, 'stats': 4 };
            if (tabMap[tabId] !== undefined) {
                buttons[tabMap[tabId]].classList.add('active');
            }

            const sheet = document.getElementById('bottom-sheet');
            if (window.innerWidth < 800) {
                sheet.style.height = '60vh';
            }

            // Load favorites and stats when switching to those tabs
            if (tabId === 'favorites') loadFavorites();
            if (tabId === 'stats') loadStats();
        }

        function selectVehicle(type, el) {
            haptic('light');
            
            document.querySelectorAll('.vehicle-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            
            const select = document.getElementById('vehicleType');
            select.value = type;
            
            // Save to storage
            saveToStorage(STORAGE_KEYS.VEHICLE, {
                type: type,
                fuelType: document.getElementById('fuelType').value,
                conso: document.getElementById('conso').value,
                drivingStyle: document.getElementById('drivingStyle').value
            });
            
            updateFuelOptions();
        }

        // Sheet Dragging
        const sheet = document.getElementById('bottom-sheet');
        const dragHandle = document.getElementById('sheet-drag');
        let startY, startHeight, isDragging = false;

        dragHandle.addEventListener('touchstart', (e) => {
            if (window.innerWidth >= 800) return;
            startY = e.touches[0].clientY;
            startHeight = sheet.offsetHeight;
            sheet.style.transition = 'none';
            isDragging = true;
            haptic('light');
        }, {passive: true});

        dragHandle.addEventListener('touchmove', (e) => {
            if (!isDragging || window.innerWidth >= 800) return;
            const delta = startY - e.touches[0].clientY;
            const newHeight = startHeight + delta;
            if(newHeight > 100 && newHeight < window.innerHeight * 0.9) {
                sheet.style.height = `${newHeight}px`;
            }
        }, {passive: true});

        dragHandle.addEventListener('touchend', () => {
            if (!isDragging || window.innerWidth >= 800) return;
            isDragging = false;
            sheet.style.transition = 'height var(--motion-duration-long) var(--motion-easing-emphasized)';
            
            if(sheet.offsetHeight > window.innerHeight * 0.7) {
                sheet.style.height = '85vh';
            } else if(sheet.offsetHeight < window.innerHeight * 0.3) {
                sheet.style.height = '45vh';
            } else {
                sheet.style.height = '60vh';
            }
            haptic('medium');
        });

        // ==========================================
        // MAP INITIALIZATION
        // ==========================================

        const map = L.map('map', { 
            zoomControl: false, 
            attributionControl: false 
        }).setView([46.603354, 1.888334], 6);
        
        L.control.attribution({ 
            position: 'topright',
            prefix: false
        }).addTo(map);

        let tileLayer;
        const lightTiles = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
        const darkTiles = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
        const satTiles = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';

        function initMapTheme() {
            const isDark = document.body.classList.contains('dark-theme');
            const isSat = document.getElementById('sat-toggle').checked;
            
            let url = isDark ? darkTiles : lightTiles;
            if (isSat) url = satTiles;

            if (tileLayer) map.removeLayer(tileLayer);
            tileLayer = L.tileLayer(url, {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
                maxZoom: 19
            }).addTo(map);

            document.getElementById('theme-toggle').checked = isDark;
        }

        initMapTheme();

        function toggleSatellite() {
            haptic('medium');
            initMapTheme();
            saveToStorage(STORAGE_KEYS.SETTINGS, getSettings());
            showToast('Vue ' + (document.getElementById('sat-toggle').checked ? 'satellite' : 'carte') + ' activée');
        }

        // ==========================================
        // MAP CLICK FUNCTIONALITY
        // ==========================================

        let mapClickEnabled = false;
        let clickWaypointIndex = 0;

        function toggleMapClick() {
            mapClickEnabled = !mapClickEnabled;
            haptic('medium');
            
            const icon = document.getElementById('map-click-icon');
            const mapElement = document.getElementById('map');
            const toggle = document.getElementById('map-click-toggle');
            
            if (mapClickEnabled) {
                icon.textContent = 'cancel';
                mapElement.classList.remove('click-disabled');
                if (toggle) toggle.checked = true;
                showToast('Cliquez sur la carte pour ajouter des points');
            } else {
                icon.textContent = 'touch_app';
                mapElement.classList.add('click-disabled');
                if (toggle) toggle.checked = false;
                showToast('Clic sur la carte désactivé');
            }
        }

        map.on('click', async function(e) {
            if (!mapClickEnabled) return;
            
            haptic('light');
            
            // Visual feedback
            const clickMarker = L.marker(e.latlng, {
                icon: L.divIcon({
                    className: 'click-indicator',
                    iconSize: [20, 20]
                })
            }).addTo(map);
            
            setTimeout(() => map.removeLayer(clickMarker), 600);

            // Reverse geocode
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
                const data = await response.json();
                
                // Determine which input to fill
                const startInput = document.getElementById('startAddr');
                const endInput = document.getElementById('endAddr');
                
                if (!startInput.value) {
                    startInput.value = data.display_name || `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
                    startInput.parentElement.classList.add('has-value');
                } else if (!endInput.value) {
                    endInput.value = data.display_name || `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
                    endInput.parentElement.classList.add('has-value');
                    mapClickEnabled = false;
                    toggleMapClick();
                } else {
                    // Add as waypoint
                    addWaypoint();
                    setTimeout(() => {
                        const inputs = document.querySelectorAll('#waypoints-container input[type="text"]');
                        const lastInput = inputs[inputs.length - 2]; // -1 is end, -2 is new waypoint
                        if (lastInput) {
                            lastInput.value = data.display_name || `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
                            lastInput.parentElement.classList.add('has-value');
                        }
                    }, 100);
                }
                
                planTrip();
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                showToast('Erreur lors de la récupération de l\'adresse', true);
            }
        });

        // ==========================================
        // WAYPOINTS MANAGEMENT
        // ==========================================

        let waypointCount = 0;
        
        function addWaypoint() {
            haptic('light');
            waypointCount++;
            const container = document.getElementById('waypoints-container');
            const endGroup = document.getElementById('wp-group-end');
            
            const div = document.createElement('div');
            div.className = 'md-input-group';
            div.id = `wp-group-${waypointCount}`;
            div.innerHTML = `
                <input type="text" class="md-input" placeholder=" " onchange="planTrip()">
                <label class="md-label">Étape ${waypointCount}</label>
                <button class="icon-btn" onclick="removeWaypoint(${waypointCount})" style="color:var(--md-sys-color-error)" aria-label="Supprimer l'étape">
                    <span class="material-symbols-rounded">delete</span>
                </button>
            `;
            container.insertBefore(div, endGroup);
            showToast('Étape ajoutée');
        }

        function removeWaypoint(id) {
            haptic('medium');
            const el = document.getElementById(`wp-group-${id}`);
            if(el) {
                el.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    el.remove();
                    planTrip();
                    showToast('Étape supprimée');
                }, 300);
            }
        }

        // ==========================================
        // GEOLOCATION
        // ==========================================

        let userLocation = null;
        
        function locateMe(inputId) {
            if (!document.getElementById('geo-toggle').checked) {
                showToast('Géolocalisation désactivée dans les paramètres', true);
                return;
            }

            haptic('light');
            if (!navigator.geolocation) {
                showToast("Géolocalisation non supportée", true);
                return;
            }
            
            const btn = event.target.closest('.icon-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<div class="spinner"></div>';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                async position => {
                    userLocation = L.latLng(position.coords.latitude, position.coords.longitude);
                    const input = document.getElementById(inputId);
                    
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`);
                        const data = await response.json();
                        
                        if(input) {
                            const address = data.address;
                            const shortAddress = [
                                address.road || address.hamlet || address.village,
                                address.city || address.town || address.municipality
                            ].filter(Boolean).join(', ') || data.display_name;
                            
                            input.value = shortAddress;
                            input.parentElement.classList.add('has-value');
                            btn.innerHTML = originalContent;
                            btn.disabled = false;
                            planTrip();
                            map.setView(userLocation, 13);
                            showToast('Position détectée');
                            haptic('success');
                        }
                    } catch (error) {
                        console.error('Geocoding error:', error);
                        if(input) {
                            input.value = `${position.coords.latitude.toFixed(5)}, ${position.coords.longitude.toFixed(5)}`;
                            input.parentElement.classList.add('has-value');
                        }
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                        planTrip();
                        map.setView(userLocation, 13);
                        showToast('Position détectée');
                    }
                },
                error => {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    console.error('Geolocation error:', error);
                    showToast("Impossible de vous géolocaliser", true);
                    haptic('error');
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        // ==========================================
        // ROUTING LOGIC
        // ==========================================

        let routeControl = null;
        let carMarker = null;
        let animationFrameId = null;
        let currentRoute = null;

        async function planTrip() {
            const inputs = document.querySelectorAll('#waypoints-container input[type="text"]');
            const addresses = Array.from(inputs).map(i => i.value.trim()).filter(v => v !== "");
            
            if (addresses.length < 2) return;

            if (routeControl) { 
                map.removeControl(routeControl); 
                routeControl = null; 
            }
            if (carMarker) { 
                map.removeLayer(carMarker); 
                cancelAnimationFrame(animationFrameId); 
            }

            document.getElementById('dist-display').innerHTML = '<div class="spinner" style="display: inline-block;"></div>';
            document.getElementById('time-display').innerHTML = '<div class="spinner" style="display: inline-block;"></div>';

            const promises = addresses.map(addr => {
                return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`)
                    .then(r => r.json())
                    .then(data => data.length > 0 ? { lat: data[0].lat, lon: data[0].lon } : null)
                    .catch(() => null);
            });

            try {
                const results = await Promise.all(promises);
                
                if (results.some(r => r === null)) {
                    showToast("Certaines adresses sont introuvables", true);
                    document.getElementById('dist-display').innerText = "0 km";
                    document.getElementById('time-display').innerText = "0 min";
                    return;
                }
                
                const waypoints = results.map(r => L.latLng(r.lat, r.lon));
                const routeAnimEnabled = document.getElementById('route-anim-toggle').checked;

                routeControl = L.Routing.control({
                    waypoints: waypoints,
                    router: L.Routing.osrmv1({ 
                        serviceUrl: 'https://router.project-osrm.org/route/v1'
                    }),
                    lineOptions: { 
                        styles: [{ 
                            color: getComputedStyle(document.body).getPropertyValue('--md-sys-color-primary'), 
                            weight: 6, 
                            opacity: 0.8,
                            className: routeAnimEnabled ? 'animated-route-line' : ''
                        }] 
                    },
                    createMarker: function(i, wp, n) {
                        const isStart = i === 0;
                        const isEnd = i === n - 1;
                        const color = isStart ? 'var(--md-sys-color-primary)' : isEnd ? 'var(--md-sys-color-error)' : 'var(--md-sys-color-secondary)';
                        
                        return L.marker(wp.latLng, {
                            draggable: true,
                            icon: L.divIcon({
                                className: 'pulse-icon',
                                html: `<div style="background-color:${color}; width:14px; height:14px; border-radius:50%; margin:3px; border:3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>`,
                                iconSize: [20, 20]
                            })
                        }).on('dragend', function() {
                            haptic('medium');
                            showToast('Point déplacé - Recalcul...');
                        });
                    },
                    addWaypoints: false,
                    show: false
                }).on('routesfound', function(e) {
                    const route = e.routes[0];
                    currentRoute = route;
                    const distKm = (route.summary.totalDistance / 1000).toFixed(1);
                    const timeMin = Math.round(route.summary.totalTime / 60);
                    
                    document.getElementById('distance').value = distKm;
                    document.getElementById('duration').value = timeMin;
                    document.getElementById('dist-display').innerText = `${distKm} km`;
                    document.getElementById('time-display').innerText = `${timeMin} min`;
                    
                    calculate();
                    updateEcoTip(distKm);
                    
                    if (document.getElementById('auto-zoom-toggle').checked) {
                        setTimeout(() => {
                            fitRoute();
                        }, 100);
                    }
                    
                    if(document.getElementById('anim-toggle').checked) {
                        setTimeout(() => {
                            animateCarAdvanced(route.coordinates);
                        }, 200);
                    }
                    
                    haptic('success');
                }).on('routingerror', function(e) {
                    showToast("Erreur lors du calcul de l'itinéraire", true);
                    document.getElementById('dist-display').innerText = "0 km";
                    document.getElementById('time-display').innerText = "0 min";
                }).addTo(map);

            } catch (error) {
                console.error('Route planning error:', error);
                showToast("Erreur lors de la planification", true);
                document.getElementById('dist-display').innerText = "0 km";
                document.getElementById('time-display').innerText = "0 min";
            }
        }

        function toggleRouteAnimation() {
            haptic('light');
            if (routeControl) {
                planTrip(); // Redraw route with/without animation
            }
            saveToStorage(STORAGE_KEYS.SETTINGS, getSettings());
        }

        function fitRoute() {
            if(routeControl) {
                const wps = routeControl.getWaypoints().filter(w => w.latLng);
                if(wps.length >= 2) {
                    const bounds = L.latLngBounds(wps.map(w => w.latLng));
                    const padding = window.innerWidth < 800 ? [50, 350] : [50, 50];
                    map.fitBounds(bounds, { 
                        padding: [50, 50],
                        paddingBottomRight: padding,
                        maxZoom: 15
                    });
                }
            }
        }

        // ==========================================
        // ADVANCED CAR ANIMATION
        // ==========================================

        function animateCarAdvanced(coords) {
            if (!coords || coords.length < 2) return;
            
            const color = getComputedStyle(document.body).getPropertyValue('--md-sys-color-primary').trim();
            
            const carIcon = L.divIcon({
                html: `
                    <div class="car-marker" style="transform-origin: center; will-change: transform;">
                        <div class="car-shadow"></div>
                        <svg viewBox="0 0 48 48" width="50" height="50" style="filter: drop-shadow(0 4px 12px rgba(0,0,0,0.4));">
                            <g id="car-body">
                                <path fill="${color}" d="M37.84 12.02C37.64 11.43 37.08 11 36.42 11H11.58c-.66 0-1.21.43-1.42 1.02L8 18v16c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2h24v2c0 .55.45 1 1 1h2c.55 0 1-.45 1-1V18l-2.16-5.98zM11.5 14h25l2.54 7.32L39.28 24H8.72l.74-2.68L11.5 14zM10 32c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm28 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                                <circle fill="white" cx="10" cy="30" r="1.5"/>
                                <circle fill="white" cx="38" cy="30" r="1.5"/>
                            </g>
                        </svg>
                    </div>
                `,
                className: '', 
                iconSize: [50, 50], 
                iconAnchor: [25, 25]
            });

            carMarker = L.marker(coords[0], { 
                icon: carIcon, 
                zIndexOffset: 999 
            }).addTo(map);
            
            let startTime = null;
            const totalDuration = Math.max(coords.length * 12, 3000); // At least 3 seconds
            let previousAngle = 0;
            
            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                let progress = elapsed / totalDuration;
                
                if (progress >= 1) { 
                    progress = 0; 
                    startTime = timestamp; 
                }

                const totalPoints = coords.length - 1;
                const currentPointIndex = Math.floor(progress * totalPoints);
                const nextPointIndex = Math.min(currentPointIndex + 1, totalPoints);
                const segmentProgress = (progress * totalPoints) - currentPointIndex;

                const c1 = coords[currentPointIndex];
                const c2 = coords[nextPointIndex];
                
                // Smooth interpolation
                const lat = c1.lat + (c2.lat - c1.lat) * segmentProgress;
                const lng = c1.lng + (c2.lng - c1.lng) * segmentProgress;
                
                carMarker.setLatLng([lat, lng]);

                // Smooth rotation
                const p1 = map.latLngToContainerPoint(c1);
                const p2 = map.latLngToContainerPoint(c2);
                
                if (p1.distanceTo(p2) > 1) {
                    let targetAngle = Math.atan2(p2.y - p1.y, p2.x - p1.x) * (180 / Math.PI) + 90;
                    
                    // Smooth angle transition
                    let angleDiff = targetAngle - previousAngle;
                    if (angleDiff > 180) angleDiff -= 360;
                    if (angleDiff < -180) angleDiff += 360;
                    previousAngle += angleDiff * 0.2; // Smooth factor
                    
                    const el = carMarker.getElement()?.querySelector('.car-marker');
                    if(el) {
                        el.style.transform = `rotate(${previousAngle}deg)`;
                    }
                }
                
                animationFrameId = requestAnimationFrame(animate);
            }
            
            animationFrameId = requestAnimationFrame(animate);
        }

        // ==========================================
        // VEHICLE & FUEL PRESETS
        // ==========================================

        const presets = {
            sedan: { 
                essence: 6.8, diesel: 5.5, elec: 16.0, ethanol: 8.5, gpl: 8.2,
                co2Factor: { essence: 2.3, diesel: 2.6, elec: 0, ethanol: 1.5, gpl: 1.6 }
            },
            suv: { 
                essence: 8.5, diesel: 7.0, elec: 20.0, ethanol: 10.5, gpl: 10.0,
                co2Factor: { essence: 2.3, diesel: 2.6, elec: 0, ethanol: 1.5, gpl: 1.6 }
            },
            city: { 
                essence: 5.2, diesel: 4.2, elec: 13.5, ethanol: 6.5, gpl: 6.5,
                co2Factor: { essence: 2.3, diesel: 2.6, elec: 0, ethanol: 1.5, gpl: 1.6 }
            },
            moto: { 
                essence: 4.0, diesel: 3.5, elec: 8.0, ethanol: 5.0, gpl: 5.0,
                co2Factor: { essence: 2.3, diesel: 2.6, elec: 0, ethanol: 1.5, gpl: 1.6 }
            },
            van: { 
                essence: 10.0, diesel: 8.0, elec: 24.0, ethanol: 12.0, gpl: 12.0,
                co2Factor: { essence: 2.3, diesel: 2.6, elec: 0, ethanol: 1.5, gpl: 1.6 }
            },
            custom: { co2Factor: { essence: 2.3, diesel: 2.6, elec: 0, ethanol: 1.5, gpl: 1.6 } }
        };

        function applyPreset() {
            const vType = document.getElementById('vehicleType').value;
            const fType = document.getElementById('fuelType').value;
            const isElec = fType === 'elec';
            
            document.getElementById('consoLabel').innerText = isElec ? "Conso. (kWh/100km)" : "Conso. Moyenne (L/100km)";
            document.getElementById('priceLabel').innerText = isElec ? "Prix (€/kWh)" : "Prix Carburant (€/L)";

            if (vType !== 'custom' && presets[vType] && presets[vType][fType] !== undefined) {
                document.getElementById('conso').value = presets[vType][fType];
            }
            
            if (document.getElementById('auto-price-toggle').checked) {
                fetchFuelPrice();
            } else {
                calculate();
            }
        }

        function updateFuelOptions() { 
            applyPreset(); 
        }

        // ==========================================
        // CALCULATION LOGIC
        // ==========================================

        function calculate() {
            const d = parseFloat(document.getElementById('distance').value) || 0;
            const c = parseFloat(document.getElementById('conso').value) || 0;
            const p = parseFloat(document.getElementById('price').value) || 0;
            const styleFactor = parseFloat(document.getElementById('drivingStyle').value) || 1;
            const fType = document.getElementById('fuelType').value;
            const vType = document.getElementById('vehicleType').value;
            
            const fuelUsed = (d * (c / 100) * styleFactor);
            const total = fuelUsed * p;
            
            // CO2 calculation
            const showCO2 = document.getElementById('co2-toggle').checked;
            const co2Factor = presets[vType]?.co2Factor?.[fType] || 2.3;
            const co2 = fType === 'elec' ? 0 : (fuelUsed * co2Factor);
            
            // Animate the price change
            const priceElement = document.getElementById('total-val');
            const currentValue = parseFloat(priceElement.innerText.replace(' €', '')) || 0;
            animateValue(priceElement, currentValue, total, 400, ' €');
            
            document.getElementById('fuel-amount').innerText = fType === 'elec' 
                ? `${fuelUsed.toFixed(1)} kWh` 
                : `${fuelUsed.toFixed(1)} L`;
            
            if (showCO2) {
                document.getElementById('co2-amount').innerText = `${co2.toFixed(1)} kg`;
            } else {
                document.getElementById('co2-amount').innerText = 'N/A';
            }
            
            const styleSel = document.getElementById('drivingStyle');
            const styleText = styleSel.options[styleSel.selectedIndex].text;
            document.getElementById('pp-val').innerText = `Pour ${d} km · Conduite ${styleText}`;
        }

        function animateValue(element, start, end, duration, suffix = '') {
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                element.innerText = current.toFixed(2) + suffix;
            }, 16);
        }

        // ==========================================
        // REAL FUEL PRICE API
        // ==========================================

        async function fetchFuelPrice() {
            haptic('light');
            const btn = document.querySelector('#refresh-icon');
            const fuelType = document.getElementById('fuelType').value;
            const priceInput = document.getElementById('price');
            const priceSource = document.getElementById('price-source');
            
            btn.style.transition = 'transform 0.6s var(--motion-easing-emphasized)';
            btn.style.transform = 'rotate(360deg)';
            setTimeout(() => btn.style.transform = 'none', 600);

            const fuelMap = {
                'essence': 'SP95',
                'diesel': 'Gazole',
                'elec': 'elec',
                'ethanol': 'E85',
                'gpl': 'GPLc'
            };

            try {
                if (fuelType === 'elec') {
                    const elecPrice = 0.2276;
                    priceInput.value = elecPrice.toFixed(4);
                    priceSource.innerText = 'Prix moyen France 2025';
                    calculate();
                    showToast('Prix électricité actualisé');
                    return;
                }

                const response = await fetch(`https://data.economie.gouv.fr/api/records/1.0/search/?dataset=prix-carburants-fichier-instantane-test-ods-copie&rows=100&facet=carburants_disponibles&refine.carburants_disponibles=${fuelMap[fuelType]}`);
                
                if (!response.ok) throw new Error('API Error');
                
                const data = await response.json();
                
                if (data.records && data.records.length > 0) {
                    const prices = data.records
                        .filter(r => r.fields[fuelMap[fuelType].toLowerCase() + '_prix'])
                        .map(r => parseFloat(r.fields[fuelMap[fuelType].toLowerCase() + '_prix']))
                        .filter(p => !isNaN(p));
                    
                    if (prices.length > 0) {
                        const avgPrice = (prices.reduce((a, b) => a + b, 0) / prices.length) / 1000;
                        priceInput.value = avgPrice.toFixed(3);
                        priceSource.innerText = `Moyenne de ${prices.length} stations`;
                        calculate();
                        showToast('Prix actualisé');
                        haptic('success');
                        return;
                    }
                }
                
                throw new Error('No data available');
                
            } catch (error) {
                console.error('Fuel price fetch error:', error);
                
                const fallbackPrices = {
                    'essence': 1.85,
                    'diesel': 1.72,
                    'ethanol': 0.89,
                    'gpl': 1.05
                };
                
                if (fallbackPrices[fuelType]) {
                    priceInput.value = fallbackPrices[fuelType].toFixed(2);
                    priceSource.innerText = 'Prix moyen indicatif 2025';
                    calculate();
                    showToast('Prix indicatif appliqué');
                }
            }
        }

        // ==========================================
        // ECO TIPS
        // ==========================================

        function updateEcoTip(distance) {
            const tips = [
                "Réduire votre vitesse de 10 km/h sur autoroute peut économiser jusqu'à 15% de carburant.",
                "Anticiper le trafic et éviter les freinages brusques réduit la consommation de 20%.",
                "Maintenir une pression correcte des pneus améliore l'efficacité énergétique de 3%.",
                "Éviter la climatisation excessive peut réduire la consommation de 10-15%.",
                "Retirer les coffres de toit et équipements inutiles diminue la résistance à l'air.",
                "Couper le moteur lors d'arrêts de plus de 20 secondes économise du carburant.",
                "Rouler en mode Éco ou utiliser le régulateur de vitesse optimise la consommation.",
                "Planifier vos trajets pour éviter les heures de pointe réduit temps et carburant.",
                "Accélérer progressivement permet d'économiser jusqu'à 10% de carburant.",
                "Entretenir régulièrement votre véhicule maintient une consommation optimale."
            ];
            
            let tip;
            if (distance > 100) {
                tip = tips[0];
            } else if (distance > 50) {
                tip = tips[Math.floor(Math.random() * 4)];
            } else {
                tip = tips[Math.floor(Math.random() * tips.length)];
            }
            
            document.getElementById('eco-tip-text').innerText = tip;
        }

        // ==========================================
        // FAVORITES MANAGEMENT
        // ==========================================

        function addToFavorites() {
            haptic('medium');
            
            const inputs = document.querySelectorAll('#waypoints-container input[type="text"]');
            const addresses = Array.from(inputs).map(i => i.value).filter(v => v);
            
            if (addresses.length < 2) {
                showToast('Veuillez d\'abord planifier un trajet', true);
                return;
            }

            const name = prompt('Nom du trajet favori:', addresses[0].split(',')[0] + ' → ' + addresses[addresses.length-1].split(',')[0]);
            if (!name) return;

            const favorite = {
                id: Date.now(),
                name: name,
                waypoints: addresses,
                distance: document.getElementById('distance').value,
                cost: document.getElementById('total-val').innerText,
                fuel: document.getElementById('fuel-amount').innerText,
                vehicle: {
                    type: document.getElementById('vehicleType').value,
                    fuelType: document.getElementById('fuelType').value,
                    conso: document.getElementById('conso').value,
                    price: document.getElementById('price').value
                },
                createdAt: new Date().toISOString()
            };

            let favorites = loadFromStorage(STORAGE_KEYS.FAVORITES, []);
            favorites.push(favorite);
            saveToStorage(STORAGE_KEYS.FAVORITES, favorites);
            
            showToast('Trajet ajouté aux favoris');
            haptic('success');
        }

        function loadFavorites() {
            const favorites = loadFromStorage(STORAGE_KEYS.FAVORITES, []);
            const container = document.getElementById('favorites-list');
            
            if (favorites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-symbols-rounded">bookmark_border</span>
                        <p>Aucun trajet favori<br><small>Ajoutez vos trajets réguliers ici</small></p>
                    </div>
                `;
                return;
            }

            container.innerHTML = favorites.map(fav => `
                <div class="favorite-item">
                    <div class="favorite-info">
                        <div class="favorite-name">${fav.name}</div>
                        <div class="favorite-details">
                            ${fav.distance} km · ${fav.cost} · ${fav.fuel}
                        </div>
                    </div>
                    <div class="favorite-actions">
                        <button class="icon-btn" onclick="loadFavorite(${fav.id})" aria-label="Charger">
                            <span class="material-symbols-rounded">directions</span>
                        </button>
                        <button class="icon-btn" onclick="deleteFavorite(${fav.id})" style="color:var(--md-sys-color-error)" aria-label="Supprimer">
                            <span class="material-symbols-rounded">delete</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadFavorite(id) {
            haptic('medium');
            const favorites = loadFromStorage(STORAGE_KEYS.FAVORITES, []);
            const favorite = favorites.find(f => f.id === id);
            
            if (!favorite) return;

            // Reset waypoints
            document.getElementById('waypoints-container').innerHTML = `
                <div class="md-input-group has-value" id="wp-group-0">
                    <input type="text" class="md-input" id="startAddr" placeholder=" " onchange="planTrip()">
                    <label class="md-label">Départ</label>
                    <button class="icon-btn" onclick="locateMe('startAddr')">
                        <span class="material-symbols-rounded">near_me</span>
                    </button>
                </div>
                <div class="md-input-group has-value" id="wp-group-end">
                    <input type="text" class="md-input" id="endAddr" placeholder=" " onchange="planTrip()">
                    <label class="md-label">Destination</label>
                    <button class="icon-btn">
                        <span class="material-symbols-rounded">flag</span>
                    </button>
                </div>
            `;
            waypointCount = 0;

            // Load waypoints
            document.getElementById('startAddr').value = favorite.waypoints[0];
            if (favorite.waypoints.length > 1) {
                document.getElementById('endAddr').value = favorite.waypoints[favorite.waypoints.length - 1];
                
                for(let i = 1; i < favorite.waypoints.length - 1; i++) {
                    addWaypoint();
                    setTimeout(() => {
                        const inputs = document.querySelectorAll('#waypoints-container input[type="text"]');
                        inputs[inputs.length - 2].value = favorite.waypoints[i];
                        inputs[inputs.length - 2].parentElement.classList.add('has-value');
                    }, 50);
                }
            }

            // Load vehicle settings
            const vCard = document.querySelector(`[data-val="${favorite.vehicle.type}"]`);
            if (vCard) selectVehicle(favorite.vehicle.type, vCard);
            
            document.getElementById('fuelType').value = favorite.vehicle.fuelType;
            document.getElementById('conso').value = favorite.vehicle.conso;
            document.getElementById('price').value = favorite.vehicle.price;

            setTimeout(() => {
                planTrip();
                switchTab('route');
                showToast('Trajet favori chargé');
            }, 200);
        }

        function deleteFavorite(id) {
            if (!confirm('Supprimer ce trajet favori ?')) return;
            
            haptic('heavy');
            let favorites = loadFromStorage(STORAGE_KEYS.FAVORITES, []);
            favorites = favorites.filter(f => f.id !== id);
            saveToStorage(STORAGE_KEYS.FAVORITES, favorites);
            loadFavorites();
            showToast('Favori supprimé');
        }

        // ==========================================
        // STATISTICS MANAGEMENT
        // ==========================================

        function updateStats() {
            if (!document.getElementById('history-toggle').checked) return;

            const distance = parseFloat(document.getElementById('distance').value) || 0;
            const cost = parseFloat(document.getElementById('total-val').innerText.replace(' €', '')) || 0;
            const fuel = parseFloat(document.getElementById('fuel-amount').innerText.split(' ')[0]) || 0;
            const co2 = parseFloat(document.getElementById('co2-amount').innerText.split(' ')[0]) || 0;

            if (distance === 0) return;

            let stats = loadFromStorage(STORAGE_KEYS.STATS, {
                totalKm: 0,
                totalTrips: 0,
                totalCost: 0,
                totalFuel: 0,
                totalCO2: 0,
                lastUpdated: null
            });

            stats.totalKm += distance;
            stats.totalTrips += 1;
            stats.totalCost += cost;
            stats.totalFuel += fuel;
            stats.totalCO2 += co2;
            stats.lastUpdated = new Date().toISOString();

            saveToStorage(STORAGE_KEYS.STATS, stats);
        }

        function loadStats() {
            const stats = loadFromStorage(STORAGE_KEYS.STATS, {
                totalKm: 0,
                totalTrips: 0,
                totalCost: 0,
                totalFuel: 0,
                totalCO2: 0
            });

            document.getElementById('total-km').innerText = stats.totalKm.toFixed(1) + ' km';
            document.getElementById('total-trips').innerText = stats.totalTrips;
            document.getElementById('total-cost').innerText = stats.totalCost.toFixed(2) + ' €';
            document.getElementById('total-fuel').innerText = stats.totalFuel.toFixed(1) + ' L';
            document.getElementById('total-co2').innerText = stats.totalCO2.toFixed(1) + ' kg';

            // Progress bar (goal: 10000 km)
            const progress = Math.min((stats.totalKm / 10000) * 100, 100);
            document.getElementById('km-progress').style.width = progress + '%';
        }

        function resetStats() {
            if (!confirm('Êtes-vous sûr de vouloir réinitialiser toutes les statistiques ?')) return;
            
            haptic('heavy');
            saveToStorage(STORAGE_KEYS.STATS, {
                totalKm: 0,
                totalTrips: 0,
                totalCost: 0,
                totalFuel: 0,
                totalCO2: 0,
                lastUpdated: new Date().toISOString()
            });
            loadStats();
            showToast('Statistiques réinitialisées');
        }

        // ==========================================
        // SAVE & LOAD TRIP
        // ==========================================

        function saveTrip() {
            haptic('medium');
            const inputs = document.querySelectorAll('#waypoints-container input[type="text"]');
            const addresses = Array.from(inputs).map(i => i.value);
            const data = {
                version: '5.0',
                timestamp: new Date().toISOString(),
                waypoints: addresses,
                vehicle: {
                    type: document.getElementById('vehicleType').value,
                    fuelType: document.getElementById('fuelType').value,
                    conso: document.getElementById('conso').value,
                    price: document.getElementById('price').value,
                    drivingStyle: document.getElementById('drivingStyle').value
                },
                route: {
                    distance: document.getElementById('distance').value,
                    duration: document.getElementById('duration').value
                },
                results: {
                    cost: document.getElementById('total-val').innerText,
                    fuel: document.getElementById('fuel-amount').innerText,
                    co2: document.getElementById('co2-amount').innerText
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `eco-drive-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('Trajet sauvegardé');
            haptic('success');
        }

        function loadTrip(input) {
            if (!input.files[0]) return;
            
            haptic('light');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    document.getElementById('waypoints-container').innerHTML = `
                        <div class="md-input-group has-value" id="wp-group-0">
                            <input type="text" class="md-input" id="startAddr" placeholder=" " onchange="planTrip()">
                            <label class="md-label">Départ</label>
                            <button class="icon-btn" onclick="locateMe('startAddr')">
                                <span class="material-symbols-rounded">near_me</span>
                            </button>
                        </div>
                        <div class="md-input-group has-value" id="wp-group-end">
                            <input type="text" class="md-input" id="endAddr" placeholder=" " onchange="planTrip()">
                            <label class="md-label">Destination</label>
                            <button class="icon-btn">
                                <span class="material-symbols-rounded">flag</span>
                            </button>
                        </div>
                    `;
                    waypointCount = 0;

                    if (data.waypoints && data.waypoints.length > 0) {
                        document.getElementById('startAddr').value = data.waypoints[0];
                        if(data.waypoints.length > 1) {
                            document.getElementById('endAddr').value = data.waypoints[data.waypoints.length - 1];
                            for(let i=1; i<data.waypoints.length - 1; i++) {
                                addWaypoint();
                                const inputs = document.querySelectorAll('#waypoints-container input[type="text"]');
                                inputs[inputs.length - 2].value = data.waypoints[i];
                                inputs[inputs.length - 2].parentElement.classList.add('has-value');
                            }
                        }
                    }

                    if(data.vehicle) {
                        const card = document.querySelector(`[data-val="${data.vehicle.type}"]`);
                        if(card) selectVehicle(data.vehicle.type, card);
                        
                        document.getElementById('fuelType').value = data.vehicle.fuelType || "essence";
                        document.getElementById('drivingStyle').value = data.vehicle.drivingStyle || "1.0";
                        
                        setTimeout(() => {
                            if(data.vehicle.conso) document.getElementById('conso').value = data.vehicle.conso;
                            if(data.vehicle.price) document.getElementById('price').value = data.vehicle.price;
                            planTrip();
                            showToast('Trajet chargé');
                            haptic('success');
                        }, 100);
                    }

                } catch(e) {
                    console.error('Load error:', e);
                    showToast('Fichier invalide', true);
                    haptic('error');
                }
            };
            
            reader.readAsText(input.files[0]);
        }

        // ==========================================
        // SHARE TRIP
        // ==========================================

        async function shareTrip() {
            haptic('medium');
            
            const total = document.getElementById('total-val').innerText;
            const dist = document.getElementById('dist-display').innerText;
            const duration = document.getElementById('time-display').innerText;
            const fuel = document.getElementById('fuel-amount').innerText;
            const co2 = document.getElementById('co2-amount').innerText;
            const style = document.getElementById('drivingStyle').selectedOptions[0].text;
            
            const text = `🚗 Eco-Drive Pro - Mon Trajet
            
📍 Distance: ${dist}
⏱️ Durée: ${duration}
⛽ Consommation: ${fuel}
💶 Coût: ${total}
🌍 CO₂: ${co2}
🎯 Conduite ${style}

Calculé avec Eco-Drive Pro Ultimate
`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Eco-Drive - Mon Trajet',
                        text: text
                    });
                    showToast('Partagé avec succès');
                    haptic('success');
                    updateStats();
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        fallbackCopy(text);
                    }
                }
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copié dans le presse-papier');
                haptic('success');
                updateStats();
            }).catch(() => {
                showToast('Impossible de copier', true);
            });
        }

        // ==========================================
        // SETTINGS MANAGEMENT
        // ==========================================

        function getSettings() {
            return {
                satellite: document.getElementById('sat-toggle').checked,
                mapClick: document.getElementById('map-click-toggle')?.checked || false,
                autoZoom: document.getElementById('auto-zoom-toggle').checked,
                carAnim: document.getElementById('anim-toggle').checked,
                routeAnim: document.getElementById('route-anim-toggle').checked,
                haptic: document.getElementById('haptic-toggle').checked,
                autoPrice: document.getElementById('auto-price-toggle').checked,
                tolls: document.getElementById('tolls-toggle').checked,
                co2: document.getElementById('co2-toggle').checked,
                history: document.getElementById('history-toggle').checked,
                geo: document.getElementById('geo-toggle').checked
            };
        }

        function loadSettings() {
            const settings = loadFromStorage(STORAGE_KEYS.SETTINGS, {});
            
            if (settings.satellite !== undefined) document.getElementById('sat-toggle').checked = settings.satellite;
            if (settings.mapClick !== undefined && document.getElementById('map-click-toggle')) {
                document.getElementById('map-click-toggle').checked = settings.mapClick;
            }
            if (settings.autoZoom !== undefined) document.getElementById('auto-zoom-toggle').checked = settings.autoZoom;
            if (settings.carAnim !== undefined) document.getElementById('anim-toggle').checked = settings.carAnim;
            if (settings.routeAnim !== undefined) document.getElementById('route-anim-toggle').checked = settings.routeAnim;
            if (settings.haptic !== undefined) document.getElementById('haptic-toggle').checked = settings.haptic;
            if (settings.autoPrice !== undefined) document.getElementById('auto-price-toggle').checked = settings.autoPrice;
            if (settings.tolls !== undefined) document.getElementById('tolls-toggle').checked = settings.tolls;
            if (settings.co2 !== undefined) document.getElementById('co2-toggle').checked = settings.co2;
            if (settings.history !== undefined) document.getElementById('history-toggle').checked = settings.history;
            if (settings.geo !== undefined) document.getElementById('geo-toggle').checked = settings.geo;
        }

        // Save settings on any toggle change
        document.querySelectorAll('#settings-dialog input[type="checkbox"]').forEach(input => {
            input.addEventListener('change', () => {
                saveToStorage(STORAGE_KEYS.SETTINGS, getSettings());
            });
        });

        // ==========================================
        // INITIALIZATION
        // ==========================================

        window.addEventListener('load', () => {
            // Load saved theme
            const savedTheme = loadFromStorage(STORAGE_KEYS.THEME, false);
            if (savedTheme) {
                document.body.classList.add('dark-theme');
            }

            // Load saved color theme
            const savedColorTheme = loadFromStorage(STORAGE_KEYS.COLOR_THEME, 'green');
            if (savedColorTheme !== 'green') {
                changeColorTheme(savedColorTheme);
            }

            // Load settings
            loadSettings();

            // Load saved vehicle
            const savedVehicle = loadFromStorage(STORAGE_KEYS.VEHICLE, null);
            if (savedVehicle) {
                const vCard = document.querySelector(`[data-val="${savedVehicle.type}"]`);
                if (vCard) selectVehicle(savedVehicle.type, vCard);
                document.getElementById('fuelType').value = savedVehicle.fuelType;
                document.getElementById('conso').value = savedVehicle.conso;
                document.getElementById('drivingStyle').value = savedVehicle.drivingStyle;
            }

            // Auto-fetch fuel price on load
            setTimeout(() => {
                if (document.getElementById('auto-price-toggle').checked) {
                    fetchFuelPrice();
                }
            }, 1500);
            
            // Apply initial preset
            applyPreset();

            // Initialize stats display
            loadStats();

            showToast('Eco-Drive Pro chargé avec succès');
        });
    </script>
</body>
</html>
